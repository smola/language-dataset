Released XU*8*614 SEQ #497
Extracted from mail message
**KIDS**:XU*8.0*614^

**INSTALL NAME**
XU*8.0*614
"BLD",1486,0)
XU*8.0*614^KERNEL^0^3130320^y
"BLD",1486,1,0)
^^1^1^3130107^
"BLD",1486,1,1,0)
See patch description on FORUM for XU*8*614.
"BLD",1486,4,0)
^9.64PA^^
"BLD",1486,6.3)
11
"BLD",1486,"KRN",0)
^9.67PA^9002226^22
"BLD",1486,"KRN",.4,0)
.4
"BLD",1486,"KRN",.401,0)
.401
"BLD",1486,"KRN",.402,0)
.402
"BLD",1486,"KRN",.403,0)
.403
"BLD",1486,"KRN",.5,0)
.5
"BLD",1486,"KRN",.84,0)
.84
"BLD",1486,"KRN",3.6,0)
3.6
"BLD",1486,"KRN",3.8,0)
3.8
"BLD",1486,"KRN",9.2,0)
9.2
"BLD",1486,"KRN",9.8,0)
9.8
"BLD",1486,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",1486,"KRN",9.8,"NM",1,0)
XQ^^0^B24099396
"BLD",1486,"KRN",9.8,"NM",2,0)
XQ12^^0^B72374012
"BLD",1486,"KRN",9.8,"NM",3,0)
XQTOC^^0^B16729237
"BLD",1486,"KRN",9.8,"NM",4,0)
XQ33^^0^B27163386
"BLD",1486,"KRN",9.8,"NM",5,0)
XQ84^^0^B60218862
"BLD",1486,"KRN",9.8,"NM",6,0)
XQ81^^0^B77142358
"BLD",1486,"KRN",9.8,"NM","B","XQ",1)

"BLD",1486,"KRN",9.8,"NM","B","XQ12",2)

"BLD",1486,"KRN",9.8,"NM","B","XQ33",4)

"BLD",1486,"KRN",9.8,"NM","B","XQ81",6)

"BLD",1486,"KRN",9.8,"NM","B","XQ84",5)

"BLD",1486,"KRN",9.8,"NM","B","XQTOC",3)

"BLD",1486,"KRN",19,0)
19
"BLD",1486,"KRN",19,"NM",0)
^9.68A^5^5
"BLD",1486,"KRN",19,"NM",1,0)
XQBUILDUSER^^0
"BLD",1486,"KRN",19,"NM",2,0)
XQBUILDMAIN^^3
"BLD",1486,"KRN",19,"NM",3,0)
XQDISPLAY OPTIONS^^3
"BLD",1486,"KRN",19,"NM",4,0)
XQ LIST UNREFERENCED OPTIONS^^0
"BLD",1486,"KRN",19,"NM",5,0)
XU USER START-UP^^3
"BLD",1486,"KRN",19,"NM","B","XQ LIST UNREFERENCED OPTIONS",4)

"BLD",1486,"KRN",19,"NM","B","XQBUILDMAIN",2)

"BLD",1486,"KRN",19,"NM","B","XQBUILDUSER",1)

"BLD",1486,"KRN",19,"NM","B","XQDISPLAY OPTIONS",3)

"BLD",1486,"KRN",19,"NM","B","XU USER START-UP",5)

"BLD",1486,"KRN",19.1,0)
19.1
"BLD",1486,"KRN",101,0)
101
"BLD",1486,"KRN",409.61,0)
409.61
"BLD",1486,"KRN",771,0)
771
"BLD",1486,"KRN",779.2,0)
779.2
"BLD",1486,"KRN",870,0)
870
"BLD",1486,"KRN",8989.51,0)
8989.51
"BLD",1486,"KRN",8989.51,"NM",0)
^9.68A^1^1
"BLD",1486,"KRN",8989.51,"NM",1,0)
XQ MENUMANAGER PROMPT^^0
"BLD",1486,"KRN",8989.51,"NM","B","XQ MENUMANAGER PROMPT",1)

"BLD",1486,"KRN",8989.52,0)
8989.52
"BLD",1486,"KRN",8993,0)
8993
"BLD",1486,"KRN",8994,0)
8994
"BLD",1486,"KRN",9002226,0)
9002226
"BLD",1486,"KRN","B",.4,.4)

"BLD",1486,"KRN","B",.401,.401)

"BLD",1486,"KRN","B",.402,.402)

"BLD",1486,"KRN","B",.403,.403)

"BLD",1486,"KRN","B",.5,.5)

"BLD",1486,"KRN","B",.84,.84)

"BLD",1486,"KRN","B",3.6,3.6)

"BLD",1486,"KRN","B",3.8,3.8)

"BLD",1486,"KRN","B",9.2,9.2)

"BLD",1486,"KRN","B",9.8,9.8)

"BLD",1486,"KRN","B",19,19)

"BLD",1486,"KRN","B",19.1,19.1)

"BLD",1486,"KRN","B",101,101)

"BLD",1486,"KRN","B",409.61,409.61)

"BLD",1486,"KRN","B",771,771)

"BLD",1486,"KRN","B",779.2,779.2)

"BLD",1486,"KRN","B",870,870)

"BLD",1486,"KRN","B",8989.51,8989.51)

"BLD",1486,"KRN","B",8989.52,8989.52)

"BLD",1486,"KRN","B",8993,8993)

"BLD",1486,"KRN","B",8994,8994)

"BLD",1486,"KRN","B",9002226,9002226)

"KRN",19,263,-1)
3^3
"KRN",19,263,0)
XQDISPLAY OPTIONS^Display Menus and Options^^M^^^^^^^^KERNEL
"KRN",19,263,1,0)
^^2^2^3130110^
"KRN",19,263,1,1,0)
This is a menu of options that will help the user display menus and their
"KRN",19,263,1,2,0)
options.
"KRN",19,263,10,0)
^19.01IP^6^6
"KRN",19,263,10,6,0)
1656
"KRN",19,263,10,6,"^")
XQ LIST UNREFERENCED OPTIONS
"KRN",19,263,99)
62830,29504
"KRN",19,263,99.1)
62453,46801
"KRN",19,263,"U")
DISPLAY MENUS AND OPTIONS
"KRN",19,822,-1)
3^2
"KRN",19,822,0)
XQBUILDMAIN^Menu Rebuild Menu^^M^^^^^^^^KERNEL^y
"KRN",19,822,1,0)
^^1^1^3130110^
"KRN",19,822,1,1,0)
This is the main menu for all menu rebuild options.
"KRN",19,822,10,0)
^19.01IP^5^5
"KRN",19,822,10,3,0)
823
"KRN",19,822,10,3,"^")
XQBUILDUSER
"KRN",19,822,99)
62830,25384
"KRN",19,822,"U")
MENU REBUILD MENU
"KRN",19,823,-1)
0^1
"KRN",19,823,0)
XQBUILDUSER^Single User Menu Tree Rebuild^^R^^^^^^^^KERNEL^y
"KRN",19,823,1,0)
^^4^4^3130108^
"KRN",19,823,1,1,0)
This option collects the menus that a user has in the primary and
"KRN",19,823,1,2,0)
secondary fields of the OPTION file (#19) and then rebuilds the menu tree.
"KRN",19,823,1,3,0)
Note that other users might have the same menu tree, but this will only 
"KRN",19,823,1,4,0)
rebuild the menu tree for the selected user.
"KRN",19,823,25)
USER^XQ84
"KRN",19,823,200.9)
^y
"KRN",19,823,"U")
SINGLE USER MENU TREE REBUILD
"KRN",19,1656,-1)
0^4
"KRN",19,1656,0)
XQ LIST UNREFERENCED OPTIONS^List Unreferenced Menu Options^^R^^^^^^^^KERNEL
"KRN",19,1656,1,0)
^^1^1^3130108^
"KRN",19,1656,1,1,0)
List unreferenced options from OPTION file (#19).
"KRN",19,1656,25)
LIST^XQ33
"KRN",19,1656,200.9)
^y
"KRN",19,1656,"U")
LIST UNREFERENCED MENU OPTIONS
"KRN",19,1657,-1)
3^5
"KRN",19,1657,0)
XU USER START-UP^User start-up event^^X^^^^^^^^KERNEL
"KRN",19,1657,1,0)
^^5^5^3130108^
"KRN",19,1657,1,1,0)
This is an option used exclusively during a VistA user sign-on event. 
"KRN",19,1657,1,2,0)
Items listed in this option are "TYPE:action" options in the OPTION file 
"KRN",19,1657,1,3,0)
(#19) that can be used to prompt users for input upon VistA sign-on and 
"KRN",19,1657,1,4,0)
before their Primary Menu Option is displayed.  It will not be used for 
"KRN",19,1657,1,5,0)
GUI sign-on.  It is called from XQ12.
"KRN",19,1657,200.9)
^y
"KRN",19,1657,"U")
USER START-UP EVENT
"KRN",8989.51,316,-1)
0^1
"KRN",8989.51,316,0)
XQ MENUMANAGER PROMPT^Non-production VistA Warning Prompt^0^^Non-production menu warning prompt^
"KRN",8989.51,316,1)
F^3:20^Enter Menu warning prompt. Default is " <TEST ACCOUNT>" without quotes
"KRN",8989.51,316,20,0)
^8989.512^4^4^3130110^^
"KRN",8989.51,316,20,1,0)
On non-production VistA systems, the text defined by this parameter is 
"KRN",8989.51,316,20,2,0)
inserted in the MenuManager prompts. If no text is defined, the 
"KRN",8989.51,316,20,3,0)
hard-coded default is " <TEST ACCOUNT>". Suggested alternatives include
"KRN",8989.51,316,20,4,0)
" <LEGACY SYSTEM>"," <CONTINGENCY>", or " <READ ONLY>".
"KRN",8989.51,316,30,0)
^8989.513I^1^1
"KRN",8989.51,316,30,1,0)
1^4.2
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
614^3130320
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^3130320
"PKG",3,22,1,"PAH",1,1,1,0)
See patch description on FORUM for XU*8*614.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","XQ")
0^1^B24099396^B26234879
"RTN","XQ",1,0)
XQ ; SEA/MJM - Menu driver (Part 1) ;01/10/13  13:41
"RTN","XQ",2,0)
 ;;8.0;KERNEL;**9,46,94,103,157,570,593,614**;Jul 10, 1995;Build 11
"RTN","XQ",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQ",4,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",5,0)
 D INIT^XQ12 Q:'$D(XQY)
"RTN","XQ",6,0)
 I $D(XQUR),$E(XQUR,1,2)="^^" S XQRB=1,XQJS=4
"RTN","XQ",7,0)
 I '$D(XQJS),$D(XQUR),XQUR'="",XQUR'["[" S:XQUR'[U XQUR=U_XQUR K ^VA(200,DUZ,202.1) S XQJS=0 D ^XQTOC
"RTN","XQ",8,0)
 I $D(XQUR),XQUR["[" K ^VA(200,DUZ,202.1) S XQJS=3,^XUTL("XQ",$J,"T")=1
"RTN","XQ",9,0)
 I $D(^VA(200,DUZ,202.1)),$L($P(^(202.1),U)) S XQJS=1 S %=+^(202.1) S XQUR=$G(^DIC(19,%,"U")) I XQUR]"" D ^XQTOC
"RTN","XQ",10,0)
M I '$D(XQVOL) S XQVOL=$G(^XUTL("XQ",$J,"XQVOL")) I '$L(XQVOL) D GETENV^%ZOSV S XQVOL=$P(Y,U,2)
"RTN","XQ",11,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) S XQNOLOG="" G H^XUS
"RTN","XQ",12,0)
 S:$S('$D(XQY0):1,'$L(XQY0):1,1:0) XQY0=^DIC(19,XQY,0) S XQT=$P(XQY0,U,4) G:XQT="" M3 K:'$D(XQJS) XQUR K X,XQNOGO,XQR,XQUIT,XQUEFLG ;,XQSV
"RTN","XQ",13,0)
 I $D(XQAUDIT),XQAUDIT D LOGOPT^XQ12
"RTN","XQ",14,0)
 I $G(XQY)>0 D CHKQUE^XQ92 I XQUEFLG S XQNOGO=""
"RTN","XQ",15,0)
 ;
"RTN","XQ",16,0)
 ;Execute the Entry Action and look for XQUIT
"RTN","XQ",17,0)
 D:'$D(XQM3)&("LOQX"'[XQT) LO K XQM3 I $D(XQUIT) D
"RTN","XQ",18,0)
 .S XQUIT=0
"RTN","XQ",19,0)
 .D ^XQUIT
"RTN","XQ",20,0)
 .Q
"RTN","XQ",21,0)
 ;
"RTN","XQ",22,0)
 G:$D(XQUR) ASK1 ;Jump start or continue
"RTN","XQ",23,0)
 I '$D(XQUIT),XQT'="A",$P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ",24,0)
 D:$D(XQXFLG)[0 ABT^XQ12
"RTN","XQ",25,0)
 D:$P(XQY0,U)]"" LOGRSRC^%ZOSV($P(XQY0,U),0,1)
"RTN","XQ",26,0)
 I XQT'="M" W:'^XUTL("XQ",$J,"T") !,$P(XQY0,U,2) W:$D(DUZ("SAV")) !,"Not when testing another's menus." S %=^XUTL("XQ",$J,"T"),^("T")=%+1,^(%+1)=XQY_XQPSM_U_XQY0 G M3:XQT'?1U!$D(DUZ("SAV"))
"RTN","XQ",27,0)
 I XQT'="M" D:'$D(XQXFLG) ABT^XQ12 D:+XQXFLG ABLOG^XQ12 K %,X,XQTT G @(XQT_"^XQ1")
"RTN","XQ",28,0)
M1 ;
"RTN","XQ",29,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",30,0)
 Q:XQY<1!'$D(^XUTL("XQ",$J,"T"))  D:'$D(XQXFLG) ABT^XQ12
"RTN","XQ",31,0)
 D:'$D(XQABOLD)&(+XQXFLG) ABLOG^XQ12 K XQABOLD W ! S XQUR=0,XQTT=^XUTL("XQ",$J,"T"),XQDIC=XQY S XQAA="Select "_$S($D(DUZ("SAV")):$P(DUZ("SAV"),U,3)_"'s ",1:"")_$P(XQY0,U,2)
"RTN","XQ",32,0)
 S XQAA=XQAA_$G(DUZ("TEST"))_" Option: " S:$D(XQMM("B")) XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",33,0)
 S:$S('XQTT:1,1:+$P(^XUTL("XQ",$J,XQTT),U,1)'=XQY) ^("T")=XQTT+1,^(XQTT+1)=XQY_XQPSM_U_XQY0 I $D(DUZ("AUTO")),DUZ("AUTO"),'$D(XQMM("J")),'$D(XQMM("N")) G EN^XQ2
"RTN","XQ",34,0)
 K:'$D(XQMM("J")) XQMM("N")
"RTN","XQ",35,0)
M2 ;
"RTN","XQ",36,0)
 I '$D(XQMMF),$D(XQMM("J")) G ^XQ74
"RTN","XQ",37,0)
 Q:$D(XQALEXIT)&'$D(XQALMENU)  K XQMMF I $D(XQMM("A")) S XQAA=XQMM("A") K XQMM("A") I $D(XQMM("B")),$L(XQMM("B")) S XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",38,0)
 D DISPLAY^XQALERT,CHK^XM
"RTN","XQ",39,0)
 S:'$D(DTIME) DTIME=60
"RTN","XQ",40,0)
 ;
"RTN","XQ",41,0)
ASK ;Get user's response in XQUR
"RTN","XQ",42,0)
 W !,XQAA R XQUR:DTIME I '$T Q:$D(XQALEXIT)  W $C(7),"  Timed out...." G CON^XQTOC
"RTN","XQ",43,0)
 I $D(XQALEXIT),XQUR=""!(XQUR["^") Q
"RTN","XQ",44,0)
 ;
"RTN","XQ",45,0)
ASK1 D SETSV ;Set XQSV to remember where we started from (XQY^XQDIC^XQY0)
"RTN","XQ",46,0)
 K XQUIT
"RTN","XQ",47,0)
 I XQUR="*",$D(DUZ("SAV")) G TESTN^XUS91
"RTN","XQ",48,0)
 I $D(XQJS),XQJS,XQJS'>2 D SET^XQTOC G JUMP^XQ72 ;Continue, 3=[LOGIN
"RTN","XQ",49,0)
 I XQUR["[" G:'$D(DUZ("SAV")) ^XQT W !,"Not when testing another's menus!" S %=^XUTL("XQ",$J,"T")+1,^("T")=%,^(%)=XQY_XQPSM_U_XQY0 G M3
"RTN","XQ",50,0)
 I XQUR="" S:$D(XQMM("B")) XQUR=XQMM("B") K XQMM("B") G:$L(XQUR) D S XQABOLD=1 G M3:^XUTL("XQ",$J,"T")>1,XPRMP^XQ12
"RTN","XQ",51,0)
 I XQUR=U G M3
"RTN","XQ",52,0)
 I $E(XQUR)=$C(34),$L(XQUR)>1 S XQUR=$P(XQUR,$C(34),2) D P^XQ75 G:XQY'>0 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G JUMP^XQ72
"RTN","XQ",53,0)
D I XQUR["^^" G:XQUR="^^" R^XQ73 S XQRB=1 S XQUR=$P(XQUR,U,2,99)
"RTN","XQ",54,0)
 ;"^^" is GO HOME, return to the Primary Menu, "^^x" is a rubber band
"RTN","XQ",55,0)
 I XQUR[U S XQUR=$P(XQUR,U,2) G:'$L(XQUR) NOFIND D S^XQ75 G D:'XQY,NOFIND:XQY<0 K XQAA S XQY=+XQY,XQCH=XQUR G:$D(XQRB) ^XQ73 G JUMP^XQ72
"RTN","XQ",56,0)
D0 G:XQUR'?1"?"1AN.ANP D1 D OPT^XQHLP G ASK
"RTN","XQ",57,0)
D1 G EN^XQ2:XQUR?."?"!(XQUR'?.ANP) D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM=$S(XQPSM=("U"_DUZ):XQPSM_",P"_XQDIC,XQPSM[",":XQPSM,XQDIC>0:XQPSM,1:"P"_XQDIC)
"RTN","XQ",58,0)
 I XQY=-1,$O(^VA(200,DUZ,203,0))>0 S XQDIC="U"_DUZ D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="U"_DUZ_",P"_XQY
"RTN","XQ",59,0)
M0 I XQY=-1 S XQDIC=$O(^DIC(19,"B","XUCOMMAND",0)) S:XQDIC="" XQDIC=-1 D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="PXU" I XQY=-1 G M3:XQUR="HALT",NOFIND
"RTN","XQ",60,0)
 G:XQY=-2 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G M
"RTN","XQ",61,0)
 ;
"RTN","XQ",62,0)
NOFIND ;Could not find the option requested, go back and try again
"RTN","XQ",63,0)
 W:XQY=-1 "  ??" S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),XQY0=$P(%,U,2,999),XQY=+$P(%,U,1) K XQJS,XQR G M1
"RTN","XQ",64,0)
 ;
"RTN","XQ",65,0)
M3 I $P(XQY0,U,15),$D(^DIC(19,+XQY,15)),$L(^(15)) X ^(15) ;W "  ==> XQ+47"
"RTN","XQ",66,0)
 S %=^XUTL("XQ",$J,"T")-1,^("T")=% G H^XUS:(%'>0) S %=^XUTL("XQ",$J,%),XQY0=$P(%,U,2,999),XQPSM=$P(%,U,1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,99),XQM3="" I +XQY<0 D RBX^XQ73
"RTN","XQ",67,0)
 G M
"RTN","XQ",68,0)
 ;
"RTN","XQ",69,0)
LO I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,+XQY,20)),$L(^(20)) X ^(20) ;W " ==> LO^XQ"
"RTN","XQ",70,0)
 Q
"RTN","XQ",71,0)
 ;
"RTN","XQ",72,0)
SETSV ;Record where we are now for posterity in XQSV
"RTN","XQ",73,0)
 ; ZEXCEPT: XQSV,XQY  - global variables recording current VistA menu
"RTN","XQ",74,0)
 N %
"RTN","XQ",75,0)
 S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T"))
"RTN","XQ",76,0)
 S XQSV=""
"RTN","XQ",77,0)
 S $P(XQSV,U)=+%
"RTN","XQ",78,0)
 S $P(XQSV,U,2)=$S($P(%,U)["PXU":$O(^DIC(19,"B","XUCOMMAND",0)),1:$P($P(%,U),"P",2)) I $P(XQSV,U,2)="" S $P(XQSV,U,2)=XQY
"RTN","XQ",79,0)
 S $P(XQSV,U,3)=$P(%,U,2,99)
"RTN","XQ",80,0)
 Q
"RTN","XQ",81,0)
 ;
"RTN","XQ",82,0)
PRIO ;This subroutine is no longer used.  Kernel no longer resets priority.
"RTN","XQ",83,0)
 ;S Y=10 X:$D(^%ZOSF("PRIINQ")) ^("PRIINQ") S ^XUTL("XQ",$J,"P")=Y,X=$P(XQY0,U,8) X ^%ZOSF("PRIORITY")
"RTN","XQ",84,0)
 Q
"RTN","XQ12")
0^2^B72374012^B72908021
"RTN","XQ12",1,0)
XQ12 ;SEA/LUKE,ISD/HGW - MENU MANAGER UTILITIES ;01/10/13  15:09
"RTN","XQ12",2,0)
 ;;8.0;KERNEL;**9,20,46,157,253,593,614**;Jul 10, 1995;Build 11
"RTN","XQ12",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ12",4,0)
 ;
"RTN","XQ12",5,0)
DVARS ;Set up (or reset) necessary variables. From ^XQ1 and ^XQT1.
"RTN","XQ12",6,0)
 S U="^" I '$D(DUZ)#2 S DUZ=^XUTL("XQ",$J,"DUZ")
"RTN","XQ12",7,0)
 S:'$D(DUZ(0))#2 DUZ(0)="" I DUZ(0)="" S:$D(^VA(200,DUZ,0)) DUZ(0)=$P(^(0),U,4)
"RTN","XQ12",8,0)
 I '$D(DT) D ^XQDATE S DT=$P(%,".")
"RTN","XQ12",9,0)
 I '$D(DUZ("AG")),$D(^XTV(8989.3,1,0)) S DUZ("AG")=$P(^(0),U,8)
"RTN","XQ12",10,0)
 I '$D(IOS) S IOS=$S($D(^XUTL("XQ",$J,"IOS"))#2:^("IOS"),1:"")
"RTN","XQ12",11,0)
 I '$D(DTIME) S DTIME=$$DTIME^XUP(DUZ,IOS)
"RTN","XQ12",12,0)
 I '$D(DUZ("AUTO")) S I=$S($D(^VA(200,DUZ,200)):$P(^(200),U,6),1:"") S:'$L(I) I=$S($D(^%ZIS(1,$I,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=$S($D(^XTV(8989.3,1,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=1 S DUZ("AUTO")=I
"RTN","XQ12",13,0)
 I '$D(DUZ("TEST"))&'$$PROD^XUPROD D
"RTN","XQ12",14,0)
 .S DUZ("TEST")=$$GET^XPAR("SYS","XQ MENUMANAGER PROMPT",1,"Q")
"RTN","XQ12",15,0)
 .I $L($G(DUZ("TEST")))<3 S DUZ("TEST")=" <TEST ACCOUNT>"
"RTN","XQ12",16,0)
 Q
"RTN","XQ12",17,0)
 ;
"RTN","XQ12",18,0)
INIT ;Entry for new logon, called from the top of ^XQ and ^XQ1
"RTN","XQ12",19,0)
 K DIC,Y Q:$D(DUZ)[0  Q:'$D(^VA(200,DUZ,0))
"RTN","XQ12",20,0)
 ;S:'$D(XQY) XQY=^VA(200,DUZ,201)
"RTN","XQ12",21,0)
 I '$D(XQUSER) S XQUSER=$P($P(^VA(200,DUZ,0),U),",",2)_" "_$P($P(^(0),U),",")
"RTN","XQ12",22,0)
 ;
"RTN","XQ12",23,0)
 ;Select device tied option, primary menu, or primary window
"RTN","XQ12",24,0)
 ;
"RTN","XQ12",25,0)
 S:'$D(XQY) XQY=""
"RTN","XQ12",26,0)
 S %=$G(^VA(200,DUZ,201)),^XUTL("XQ",$J,"XQM")=+%,^("XQW")=$P(%,"^",2)
"RTN","XQ12",27,0)
 D:'$D(IO) HOME^%ZIS
"RTN","XQ12",28,0)
 I IO]"" S %=$G(^%ZIS(1,IO,201)) I %]"" S XQY=%
"RTN","XQ12",29,0)
 I XQY']"" D
"RTN","XQ12",30,0)
 .S %=$G(^VA(200,DUZ,201))
"RTN","XQ12",31,0)
 .S XQPM=$P(%,U),XQPW=$P(%,U,2),XQSD=$P(%,U,3)
"RTN","XQ12",32,0)
 .I XQPW']"" S XQY=XQPM Q
"RTN","XQ12",33,0)
 .I XQSD="M" S XQY=XQPM
"RTN","XQ12",34,0)
 .E  S XQY=XQPW
"RTN","XQ12",35,0)
 .Q
"RTN","XQ12",36,0)
 ;
"RTN","XQ12",37,0)
 D SET^XQCHK
"RTN","XQ12",38,0)
 S ^XUTL("XQ",$J,1)=XQY_"P"_XQY_"^"_XQY0,^("T")=1
"RTN","XQ12",39,0)
 S XQDIC=XQY,XQPSM="P"_XQY
"RTN","XQ12",40,0)
 ;
"RTN","XQ12",41,0)
 ; P593 Run XU USER START-UP menu option for terminal sessions only
"RTN","XQ12",42,0)
 I $E($G(IOST),1,2)="C-" S XUSQUIT=$$STARTUP() G:XUSQUIT HALT
"RTN","XQ12",43,0)
 ;
"RTN","XQ12",44,0)
 ;D MERGE,MGPXU,MGSEC ;get the menu trees this user will need to jump
"RTN","XQ12",45,0)
 ;
"RTN","XQ12",46,0)
 ;Fire LOGIN menu template if they have one and its the first login
"RTN","XQ12",47,0)
 ;of the day.  XQXFLG("LLOG") is copy of ^VA(200,DUZ,1.1) before it's
"RTN","XQ12",48,0)
 ;updated at XUS1+47
"RTN","XQ12",49,0)
 I $D(^VA(200,DUZ,19.8,"B","LOGIN")) D
"RTN","XQ12",50,0)
 .Q:'$D(XQXFLG("LLOG"))
"RTN","XQ12",51,0)
 .S XQLAST=$P($P(XQXFLG("LLOG"),U),".") ;Get last login DT
"RTN","XQ12",52,0)
 .Q:+XQLAST<1
"RTN","XQ12",53,0)
 .I XQLAST<DT S XQUR="[LOGIN",XQJS=3
"RTN","XQ12",54,0)
 .K XQLAST
"RTN","XQ12",55,0)
 .Q
"RTN","XQ12",56,0)
 K XQXFLG("LLOG")
"RTN","XQ12",57,0)
 ;
"RTN","XQ12",58,0)
UI ;Entry for TaskMan (DUZ may =  0), from ZTSK^XQ1
"RTN","XQ12",59,0)
 D DVARS I '$D(^XUTL("XQ",$J,0)) D ^XQDATE S ^XUTL("XQ",$J,0)=%_U_%Y
"RTN","XQ12",60,0)
 S:'$D(XQDIC) XQDIC="P"_XQY
"RTN","XQ12",61,0)
 S:'$D(XQPSM) XQPSM="P"_XQY
"RTN","XQ12",62,0)
 S:'$D(XQJS)&'$D(ZTQUEUED) XQY0=^DIC(19,XQY,0),^XUTL("XQ",$J,"T")=0,^("DUZ")=DUZ,^("XQM")=XQY,XQPSM="P"_XQY
"RTN","XQ12",63,0)
 S XQCY=XQY D ^XQCHK I XQCY<1 D
"RTN","XQ12",64,0)
 .S XQPRMN=1,XQL=0
"RTN","XQ12",65,0)
 .D:'$D(ZTQUEUED) MES^XQCHK,PAUSE^XQ6
"RTN","XQ12",66,0)
 .S XQY=-1
"RTN","XQ12",67,0)
 .Q
"RTN","XQ12",68,0)
 S XQM3="" I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,XQY,20)),$L(^(20)) X ^(20) ;W "  ==> XQ12+59"
"RTN","XQ12",69,0)
 I $D(XQUIT),'$D(ZTQUEUED) D PM^XQUIT I $D(XQUIT) S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",70,0)
ABT ;WARNING: XQXFLG is also used by OERR test sites.
"RTN","XQ12",71,0)
 S U="^"
"RTN","XQ12",72,0)
 S $P(XQXFLG,U)=$S($O(^XTV(8989.3,1,"ABPKG",0))>0:1,1:0)
"RTN","XQ12",73,0)
CMP S $P(XQXFLG,U,2)=$S('$D(^XTV(8989.3,1,"XUCP")):0,1:^("XUCP")="Y")
"RTN","XQ12",74,0)
 K %,%Y,PGM,X,XQCY,XQPM,XQPXU,XQPW,XQSD
"RTN","XQ12",75,0)
 Q
"RTN","XQ12",76,0)
MERGE ;Merge in the menu trees that this user needs, start with Primary Menu
"RTN","XQ12",77,0)
 Q:'$D(^DIC(19,"AXQ",XQPSM))
"RTN","XQ12",78,0)
 I $D(^XUTL("XQO","XQMERGED",XQPSM)) D OLDF(XQPSM)
"RTN","XQ12",79,0)
 Q:$D(^XUTL("XQO","XQMERGED",XQPSM))  ;It's already being done
"RTN","XQ12",80,0)
 ;
"RTN","XQ12",81,0)
 L +^XUTL("XQO",XQPSM):DILOCKTM Q:'$T
"RTN","XQ12",82,0)
 S ^XUTL("XQO","XQMERGED",XQPSM)=$H
"RTN","XQ12",83,0)
 ;
"RTN","XQ12",84,0)
 K ^XUTL("XQO",XQPSM)
"RTN","XQ12",85,0)
 M ^XUTL("XQO",XQPSM)=^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",86,0)
 ;
"RTN","XQ12",87,0)
 L -^XUTL("XQO",XQPSM)
"RTN","XQ12",88,0)
 K ^XUTL("XQO","XQMERGED",XQPSM)
"RTN","XQ12",89,0)
 Q
"RTN","XQ12",90,0)
 ;
"RTN","XQ12",91,0)
MGPXU ;Check for XUCOMMAND
"RTN","XQ12",92,0)
 Q:'$D(^DIC(19,"AXQ","PXU"))
"RTN","XQ12",93,0)
 I $D(^XUTL("XQO","XQMERGED","PXU")) D OLDF("PXU")
"RTN","XQ12",94,0)
 Q:$D(^XUTL("XQO","XQMERGED","PXU"))  ;Already being merged
"RTN","XQ12",95,0)
 ;
"RTN","XQ12",96,0)
 L +^XUTL("XQO","PXU"):DILOCKTM Q:'$T
"RTN","XQ12",97,0)
 S ^XUTL("XQO","XQMERGED","PXU")=$H
"RTN","XQ12",98,0)
 ;
"RTN","XQ12",99,0)
 K ^XUTL("XQO","PXU")
"RTN","XQ12",100,0)
 M ^XUTL("XQO","PXU")=^DIC(19,"AXQ","PXU")
"RTN","XQ12",101,0)
 ;
"RTN","XQ12",102,0)
 L -^XUTL("XQO","PXU")
"RTN","XQ12",103,0)
 K ^XUTL("XQO","XQMERGED","PXU")
"RTN","XQ12",104,0)
 Q
"RTN","XQ12",105,0)
 ;
"RTN","XQ12",106,0)
MGSEC ;Now the Secondary Menu trees
"RTN","XQ12",107,0)
 N %,%1
"RTN","XQ12",108,0)
 F %=0:0 S %=$O(^VA(200,DUZ,203,"B",%)) Q:%'=+%  D
"RTN","XQ12",109,0)
 .S %1="P"_%
"RTN","XQ12",110,0)
 .I '$D(^XUTL("XQO",%1)),$D(^DIC(19,"AXQ",%1)) D
"RTN","XQ12",111,0)
 ..I $D(^XUTL("XQO","XQMERGED",%1)) D OLDF(%1)
"RTN","XQ12",112,0)
 ..Q:$D(^XUTL("XQO","XQMERGED",%1))  ;Already merging as we speak
"RTN","XQ12",113,0)
 ..S ^XUTL("XQO","XQMERGED",%1)=$H
"RTN","XQ12",114,0)
 ..L +^XUTL("XQO",%1):DILOCKTM Q:'$T
"RTN","XQ12",115,0)
 ..I '$D(^XUTL("XQO",%1)) D
"RTN","XQ12",116,0)
 ...K ^XUTL("XQO",%1)
"RTN","XQ12",117,0)
 ...M ^XUTL("XQO",%1)=^DIC(19,"AXQ",%1)
"RTN","XQ12",118,0)
 ...Q
"RTN","XQ12",119,0)
 ..L -^XUTL("XQO",%1)
"RTN","XQ12",120,0)
 ..K ^XUTL("XQO","XQMERGED",%1)
"RTN","XQ12",121,0)
 ..Q
"RTN","XQ12",122,0)
 .Q
"RTN","XQ12",123,0)
 Q
"RTN","XQ12",124,0)
 ;
"RTN","XQ12",125,0)
OLDF(X) ;See if this flag is au current, if not KILL it
"RTN","XQ12",126,0)
 ;X is the P name of the tree, e.g., P9 might be EVE
"RTN","XQ12",127,0)
 S:'$D(XQPXU) XQPXU=$G(^DIC(19,"AXQ","PXU",0))
"RTN","XQ12",128,0)
 I XQPXU="" S XQPXU=$H ;Assume it's rebuilding now
"RTN","XQ12",129,0)
 N Y,Z
"RTN","XQ12",130,0)
 S Y=$G(^XUTL("XQO","XQMERGED",X)) Q:Y=""  ;Flag's gone
"RTN","XQ12",131,0)
 S Z=$$HDIFF^XLFDT(XQPXU,Y,2)
"RTN","XQ12",132,0)
 I Z<3600 K ^XUTL("XQO","XQMERGED",X) ;Old Flag
"RTN","XQ12",133,0)
 Q
"RTN","XQ12",134,0)
 ;
"RTN","XQ12",135,0)
LOGOPT ;Option audit
"RTN","XQ12",136,0)
 S:'$D(XQLTL) XQLTL=""
"RTN","XQ12",137,0)
 S %=$P($H,",",2),%=DT_(%\60#60/100+(%\3600)+(%#60/10000)/100)
"RTN","XQ12",138,0)
 I XQLTL S $P(^XUSEC(19,XQLTL,0),U,5)=%,XQLTL=0
"RTN","XQ12",139,0)
 S I=1 I XQAUDIT'=1 S I=0 F J=1:2 S K1=$P(XQAUDIT,U,J),K2=$P(XQAUDIT,U,J+1) Q:'$L(K1)!I  I K1=2&(K2=XQY)!(K1=3&($E($P(XQY0,U,1),1,$L(K2))=K2)) S I=1
"RTN","XQ12",140,0)
 Q:'I  S XQLTL=% L +^XUSEC(19,0):0 S %=^XUSEC(19,0),XQLTL=XQLTL+(.00000001*$S(XQLTL'=$E($P(%,U,3),1,14):10,1:$E($P(%,U,3),15,16)+1)),$P(^(0),U,3,4)=XQLTL_"^"_($P(%,U,4)+1) L -^XUSEC(19,0)
"RTN","XQ12",141,0)
 D GETENV^%ZOSV S XUVOL=$P(Y,U,2),^XUSEC(19,XQLTL,0)=XQY_U_DUZ_U_$I_U_$J_"^^"_XUVOL
"RTN","XQ12",142,0)
 K K1,K2
"RTN","XQ12",143,0)
 Q
"RTN","XQ12",144,0)
XPRMP D CHK^XM W !!,"Do you really want to ",$S(XQUR="REST":"restart",1:"halt"),"? YES// " R X:10 S:'$L(X) X="Y"
"RTN","XQ12",145,0)
 I "Yy"'[$E(X) S Y=1 S:^XUTL("XQ",$J,"T")>1 Y=^("T")-1 S ^("T")=Y,Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_$G(DUZ("TEST"))_" Option: " W ! G ASK^XQ
"RTN","XQ12",146,0)
 G REST:XQUR="REST",HALT:XQUR'="CON"
"RTN","XQ12",147,0)
 ;
"RTN","XQ12",148,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQ12",149,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQ12",150,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQ12",151,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_$G(DUZ("TEST"))_" Option: " G ASK^XQ
"RTN","XQ12",152,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQ12",153,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQ12",154,0)
 W !!,$P("HMM^OK^ALL RIGHT^WELL CERTAINLY^FINE","^",$R(5)+1),"... ",$P("SEE YOU LATER^I'LL BE READY WHEN YOU ARE.^HURRY BACK!^HAVE A GOOD LUNCH BREAK!","^",$R(3)+X+1)
"RTN","XQ12",155,0)
HALT ;
"RTN","XQ12",156,0)
 G H^XUS
"RTN","XQ12",157,0)
REST S XQNOHALT=1 D ^XUSCLEAN G ^XUS
"RTN","XQ12",158,0)
 ;
"RTN","XQ12",159,0)
SS ;Search Secondaries for a particular option.
"RTN","XQ12",160,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQ12",161,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQ12",162,0)
 Q
"RTN","XQ12",163,0)
ABLOG S %2=0 F %3=0:0 S %2=$O(^XTV(8989.3,1,"ABPKG",%2)) Q:%2'>0  F %=0:0 S %=$O(^XTV(8989.3,1,"ABPKG",%2,1,%)) Q:%'>0  S %1=$P(^(%,0),U) I $E(XQY0,1,$L(%1))=%1,$E(XQY0,$L(%1)+1)'="Z" D ABLOG1
"RTN","XQ12",164,0)
 K %,%1,%2,%3,%4
"RTN","XQ12",165,0)
 Q
"RTN","XQ12",166,0)
ABLOG1 F %4=0:0 S %4=$O(^XTV(8989.3,1,"ABPKG",%2,1,%,1,%4)) Q:%4'>0  S %1=$P(^(%4,0),U) I $E(XQY0,1,$L(%1))=%1 Q
"RTN","XQ12",167,0)
 I %4'>0 S:'$D(^XTV(8989.3,1,"ABOPT",0)) ^(0)="^8989.333P^" S:'$D(^(XQY)) %4=+$P(^(0),U,3),$P(^(0),U,3,4)=$S(XQY>%4:XQY,1:%4)_U_($P(^(0),U,4)+1) S ^(0)=XQY_U_($S($D(^(XQY,0)):$P(^(0),U,2),1:0)+1),%2="A"
"RTN","XQ12",168,0)
 Q
"RTN","XQ12",169,0)
STARTUP() ; P593 Run XU USER START-UP option
"RTN","XQ12",170,0)
 N XUSER,XUSQUIT,XUDISV ;Protect ourself.
"RTN","XQ12",171,0)
 S DIC="^DIC(19,",X="XU USER START-UP",XUSQUIT=0
"RTN","XQ12",172,0)
 S XUDISV=$G(^DISV(DUZ,"^DIC(19,")) ;p614 Save OPTION value for <spacebar><return>
"RTN","XQ12",173,0)
 D EN^XQOR
"RTN","XQ12",174,0)
 I $G(XUDISV)>0 S ^DISV(DUZ,"^DIC(19,")=XUDISV ;p614 Restore OPTION value for <spacebar><return>
"RTN","XQ12",175,0)
 K X,DIC
"RTN","XQ12",176,0)
 Q XUSQUIT ;If option set XUSQUIT will stop sign-on.
"RTN","XQ12",177,0)
SAMPLE ; P593 sample start-up option
"RTN","XQ12",178,0)
 N DA
"RTN","XQ12",179,0)
 S DA=+DUZ
"RTN","XQ12",180,0)
 W !!,"  Sample: Testing XU USER START-UP option for patch XU*8.0*593"
"RTN","XQ12",181,0)
 W !!,"  Sample: Prompt to edit fields in NEW PERSON file (#200)",!
"RTN","XQ12",182,0)
 S DA=+DUZ,DIE="^VA(200,",DR="20.2;20.3;.132;.138" D ^DIE
"RTN","XQ12",183,0)
 W !!,"  Sample: Yes(Y) or No(N) prompt."
"RTN","XQ12",184,0)
 W !,"     Entering Y will set the variable XUSQUIT to 1 and end your session."
"RTN","XQ12",185,0)
 W !,"     Entering anything else (including ^ or <CR>) will continue."
"RTN","XQ12",186,0)
 W !,"     Do you want to end your session now" D YN^DICN I %=1 S XUSQUIT=%
"RTN","XQ12",187,0)
 W !!,"  Sample: End of sample script."
"RTN","XQ12",188,0)
 Q
"RTN","XQ33")
0^4^B27163386^B11485714
"RTN","XQ33",1,0)
XQ33 ;SEA/AMF/JLI/MJM,ISD/HGW - REMOVE UNREFERENCED OPTIONS ;02/07/13  08:04
"RTN","XQ33",2,0)
 ;;8.0;KERNEL;**49,73,46,614**;Jul 10, 1995;Build 11
"RTN","XQ33",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ33",4,0)
 ;
"RTN","XQ33",5,0)
DUO ; Entry point to delete unreferenced options from the option file.
"RTN","XQ33",6,0)
 W !!,*7,"Do you want to delete unreferenced options" S %=2 D YN^DICN Q:%<0!(%=2)  I '% W !,"Enter a 'Y' if you want an opportunity to delete orphan options which are not",!,"primary menus, secondary menus, or tasked." G DUO
"RTN","XQ33",7,0)
 K ^TMP($J) S IOP="HOME" D ^%ZIS K IOP S XQENT=0
"RTN","XQ33",8,0)
 R !!,"Select PACKAGE/OPTION name: ALL// ",X:DTIME S:'$T X=U S DIC=9.4,DIC(0)="EMZ" Q:X[U  S:'$L(X) X="ALL"
"RTN","XQ33",9,0)
 I X="ALL" S XQS="@z",XQE="zzz" G GET
"RTN","XQ33",10,0)
 D ^DIC I Y>0 S XQS=$P(Y(0),U,2),XQE=XQS_"zzz" G GET
"RTN","XQ33",11,0)
 S DIC=19,DIC(0)="QEMZ" D ^DIC G:Y<0 DUO S XQE=$P(Y(0),U,1),XQS=$E(XQE,1,$L(XQE)-1)_$C($A($E(XQE,$L(XQE))-1))_"zzz"
"RTN","XQ33",12,0)
GET W !,"Getting the list of unreferenced options..." D LP W ! I '$D(^TMP($J)) W "...NONE FOUND",! G OUT
"RTN","XQ33",13,0)
 S XQI=0 F XQII=0:1 S DIC="^DIC(19,",DR="",XQI=$O(^TMP($J,XQI)) Q:XQI'>0  S DA=XQI W @IOF K S D EN^DIQ D DUO1 Q:XQSTOP
"RTN","XQ33",14,0)
 G OUT
"RTN","XQ33",15,0)
DUO1 ;
"RTN","XQ33",16,0)
 W !!,"Want to delete this option" S %=2,XQSTOP=0 D YN^DICN S:%<0 XQSTOP=1 Q:%<0!(%=2)  I '% W !,"Enter a 'Y' if you want to remove this option from the option file" G DUO1
"RTN","XQ33",17,0)
 S DIK="^DIC(19," D ^DIK
"RTN","XQ33",18,0)
 Q
"RTN","XQ33",19,0)
LP S XQUI=0,XQJ=XQS F  S XQJ=$O(^DIC(19,"B",XQJ)) Q:XQJ=""!XQUI!(XQJ]XQE)  D LP1
"RTN","XQ33",20,0)
 Q
"RTN","XQ33",21,0)
LP1 S XQI=0 F  S XQI=$O(^DIC(19,"B",XQJ,XQI)) Q:XQI'>0!XQUI  D LP2
"RTN","XQ33",22,0)
 Q
"RTN","XQ33",23,0)
LP2 I "BOQSX"[$P(^DIC(19,XQI,0),U,4) K XQFL Q  ;Special options
"RTN","XQ33",24,0)
 S XQFL="" W:XQENT !,XQJ,?31 I '$D(^DIC(19,"AD",XQI)) W:XQENT "** no parents **" G PRI
"RTN","XQ33",25,0)
 K XQFL S (XQK,XQLEN,XQNM)=0
"RTN","XQ33",26,0)
 I XQENT F  S XQK=$O(^DIC(19,"AD",XQI,XQK)) Q:XQK'>0  I $D(^DIC(19,XQK,0)) S L=$P(^DIC(19,XQK,0),U,1) S:XQLEN+$L(L)+2>34 XQLEN=0 W:'XQLEN&XQNM !?31 W:XQNM&XQLEN ", " W $P(^DIC(19,XQK,0),U,1) S XQLEN=XQLEN+$L(L)+2,XQNM=XQNM+1
"RTN","XQ33",27,0)
PRI ;
"RTN","XQ33",28,0)
 I $D(^VA(200,"AP",XQI)) W:XQENT ?65,"-P-" K XQFL ;Primary Menu
"RTN","XQ33",29,0)
 I $D(^VA(200,"AD",XQI)) W:XQENT ?70,"-S-" K XQFL ;Secondary Menu
"RTN","XQ33",30,0)
 I $D(^DIC(19,XQI,200.9)),^(200.9)["y" W:XQENT&($P(^(200.9),U)["y") ?75,"-T-" K XQFL ;Taskman or don't delete
"RTN","XQ33",31,0)
 E  I $D(^DIC(19.2,"B",XQI)) W:XQENT ?75,"-T-" K XQFL ;Taskman
"RTN","XQ33",32,0)
 I $D(XQFL) S ^TMP($J,XQI)=""
"RTN","XQ33",33,0)
 Q
"RTN","XQ33",34,0)
OUT D ^%ZISC
"RTN","XQ33",35,0)
 K XQUI,XQJ,XQS,XQE,XQK,XQLEN,XQNM,XQI,I,J,K,C,L,DIC,POP,X,XQDSH,XQENT,XQHDR,XQP,Y,ZISI,ZTDTH,ZTSAVE,ZTRTN,ZTDESC,%A1,S,XQFL
"RTN","XQ33",36,0)
 K %Y,A,D0,D1,DA,DIW,DIWF,DIWL,DIWR,DIWT,DK,DL,DN,DR,DX,XQSTOP
"RTN","XQ33",37,0)
 Q
"RTN","XQ33",38,0)
LIST ; Entry point to list unreferenced options from the OPTION file (#19).
"RTN","XQ33",39,0)
 ; ZEXCEPT: XUAXQE,XUAXQS ;global within this routine
"RTN","XQ33",40,0)
 W !!,"LIST UNREFERENCED OPTIONS",!!,"Print unreferenced options for a selected package."
"RTN","XQ33",41,0)
 S IOP="HOME" D ^%ZIS K IOP
"RTN","XQ33",42,0)
 R !!,"Select PACKAGE/OPTION name: ALL// ",X:DTIME S:'$T X=U S DIC=9.4,DIC(0)="EMZ" Q:X[U  S:'$L(X) X="ALL"
"RTN","XQ33",43,0)
 I X="ALL" S XUAXQS="@z",XUAXQE="zzz" G QUEUE
"RTN","XQ33",44,0)
 D ^DIC I Y>0 S XUAXQS=$P(Y(0),U,2),XUAXQE=XUAXQS_"zzz" G QUEUE
"RTN","XQ33",45,0)
 S DIC=19,DIC(0)="QEMZ"
"RTN","XQ33",46,0)
 D ^DIC G:Y<0 EXIT
"RTN","XQ33",47,0)
 S XUAXQE=$P(Y(0),U,1),XUAXQS=$E(XUAXQE,1,$L(XUAXQE)-1)_$C($A($E(XUAXQE,$L(XUAXQE))-1))_"zzz"
"RTN","XQ33",48,0)
QUEUE ;
"RTN","XQ33",49,0)
 S %ZIS="MQ" K IOP,ZTIO,ZTSAVE D ^%ZIS G EXIT:POP
"RTN","XQ33",50,0)
 I IO'=IO(0) S ZTSAVE("XUA*")="",ZTRTN="START^XQ33",ZTDESC="List Unreferenced Options" D ^%ZTLOAD,^%ZISC,EXIT Q
"RTN","XQ33",51,0)
START ;
"RTN","XQ33",52,0)
 N XUATDY,XUAHDR,XUANAME,XUAIEN
"RTN","XQ33",53,0)
 S U="^"
"RTN","XQ33",54,0)
 S Y=DT D DD^%DT S XUATDY=Y
"RTN","XQ33",55,0)
 S XUAHDR(1)="LIST UNREFERENCED OPTIONS                     "_XUATDY
"RTN","XQ33",56,0)
 S XUAHDR(2)="Option Name                     Menu Text"
"RTN","XQ33",57,0)
 S XUAHDR(3)=$$REPEAT^XLFSTR("-",80)
"RTN","XQ33",58,0)
 K ^TMP($J)
"RTN","XQ33",59,0)
 D GETO
"RTN","XQ33",60,0)
 D PRINT
"RTN","XQ33",61,0)
 D EXIT
"RTN","XQ33",62,0)
 Q
"RTN","XQ33",63,0)
GETO ; Gets the unreferenced option
"RTN","XQ33",64,0)
 ; ZEXCEPT: XUAFLAG,XUAIEN,XUANAME,XUAXQS ;global within this routine
"RTN","XQ33",65,0)
 W !,"Getting the list of unreferenced options..."
"RTN","XQ33",66,0)
 ; Build the list
"RTN","XQ33",67,0)
 S XUANAME=XUAXQS
"RTN","XQ33",68,0)
 F  S XUANAME=$O(^DIC(19,"B",XUANAME)) Q:XUANAME=""!(XUANAME]XUAXQE)  D
"RTN","XQ33",69,0)
 .S XUAIEN=0
"RTN","XQ33",70,0)
 .F  S XUAIEN=$O(^DIC(19,"B",XUANAME,XUAIEN)) Q:XUAIEN'>0  D
"RTN","XQ33",71,0)
 ..I "BOQSX"[$P($G(^DIC(19,XUAIEN,0)),U,4) K XUAFLAG Q
"RTN","XQ33",72,0)
 ..S XUAFLAG="DATA"
"RTN","XQ33",73,0)
 ..I $D(^DIC(19,"AD",XUAIEN)) K XUAFLAG ;Menu Item
"RTN","XQ33",74,0)
 ..I $D(^VA(200,"AP",XUAIEN)) K XUAFLAG ;Primary Menu
"RTN","XQ33",75,0)
 ..I $D(^VA(200,"AD",XUAIEN)) K XUAFLAG ;Secondary Menu
"RTN","XQ33",76,0)
 ..I $D(^DIC(19,XUAIEN,200.9)),^(200.9)["y" K XUAFLAG ;Taskman or don't delete
"RTN","XQ33",77,0)
 ..E  I $D(^DIC(19.2,"B",XUAIEN)) K XUAFLAG ;Taskman
"RTN","XQ33",78,0)
 ..I $D(XUAFLAG) S ^TMP($J,XUANAME)=XUAIEN
"RTN","XQ33",79,0)
 Q
"RTN","XQ33",80,0)
PRINT ; Print the list
"RTN","XQ33",81,0)
 ; ZEXCEPT: I,IOF,IOSL,IOST,X,XUAIEN,XUANAME ;global within this routine
"RTN","XQ33",82,0)
 N END,XUAPAGE,XUALINE,XUATEXT
"RTN","XQ33",83,0)
 S END=0,XUAPAGE=1
"RTN","XQ33",84,0)
 D HEAD
"RTN","XQ33",85,0)
 I '$D(^TMP($J)) W "...NONE FOUND",! Q
"RTN","XQ33",86,0)
 S XUANAME=""
"RTN","XQ33",87,0)
 F  S XUANAME=$O(^TMP($J,XUANAME)) Q:XUANAME=""!END  D
"RTN","XQ33",88,0)
 .S XUAIEN=^TMP($J,XUANAME)
"RTN","XQ33",89,0)
 .S XUATEXT=$P($G(^DIC(19,XUAIEN,0)),U,2)
"RTN","XQ33",90,0)
 .W !,XUANAME,?32,$E(XUATEXT,1,47)
"RTN","XQ33",91,0)
 .S XUALINE=XUALINE+1
"RTN","XQ33",92,0)
 .I XUALINE=IOSL D
"RTN","XQ33",93,0)
 ..I $E(IOST,1,2)'="C-" D
"RTN","XQ33",94,0)
 ...W @IOF
"RTN","XQ33",95,0)
 ...S XUAPAGE=XUAPAGE+1 D HEAD
"RTN","XQ33",96,0)
 ..I $E(IOST,1,2)="C-" D
"RTN","XQ33",97,0)
 ...W !,"Press RETURN to continue or '^' to exit: "
"RTN","XQ33",98,0)
 ...R X:DTIME
"RTN","XQ33",99,0)
 ...S END='$T!(X="^") Q:END
"RTN","XQ33",100,0)
 ...S XUAPAGE=XUAPAGE+1 D HEAD
"RTN","XQ33",101,0)
 I $E(IOST,1,2)="C-" D
"RTN","XQ33",102,0)
 .S XUALINE=XUALINE+1
"RTN","XQ33",103,0)
 .F I=XUALINE:1:IOSL W !
"RTN","XQ33",104,0)
 .W !,"Press RETURN to exit: "
"RTN","XQ33",105,0)
 .R X:DTIME
"RTN","XQ33",106,0)
 Q
"RTN","XQ33",107,0)
HEAD ;
"RTN","XQ33",108,0)
 ; ZEXCEPT: XUAHDR,XUALINE,XUAPAGE ;used within this routine
"RTN","XQ33",109,0)
 W !,XUAHDR(1),"           PAGE ",XUAPAGE,!,XUAHDR(2),!,XUAHDR(3)
"RTN","XQ33",110,0)
 S XUALINE=4
"RTN","XQ33",111,0)
 Q
"RTN","XQ33",112,0)
EXIT ;
"RTN","XQ33",113,0)
 D ^%ZISC
"RTN","XQ33",114,0)
 K XUAFLAG
"RTN","XQ33",115,0)
 K I,J,K,C,L,DIC,POP,X,Y,ZISI,ZTDTH,ZTSAVE,ZTRTN,ZTDESC,%A1,S
"RTN","XQ33",116,0)
 K %Y,A,D0,D1,DA,DIW,DIWF,DIWL,DIWR,DIWT,DK,DL,DN,DR,DX
"RTN","XQ33",117,0)
 Q
"RTN","XQ81")
0^6^B77142358^B75894381
"RTN","XQ81",1,0)
XQ81 ;SEA/AMF/LUKE,SF/RWF,ISD/HGW - Build menu trees ;03/19/13  09:21
"RTN","XQ81",2,0)
 ;;8.0;KERNEL;**81,116,157,253,478,614**;Jul 10, 1995;Build 11
"RTN","XQ81",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ81",4,0)
 ;
"RTN","XQ81",5,0)
BUILD ;
"RTN","XQ81",6,0)
 ;
"RTN","XQ81",7,0)
RD2 N XQSTAT S XQSTAT=$$STATUS()
"RTN","XQ81",8,0)
 I 'XQSTAT W !!,"Some one else is rebuilding menus.  Sorry." Q
"RTN","XQ81",9,0)
 K ZTSK
"RTN","XQ81",10,0)
 D MICRO ;Turn off micro surgery for now
"RTN","XQ81",11,0)
 ;
"RTN","XQ81",12,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",13,0)
 K XQFG W !!,"This option will build menu trees for each primary and secondary menu.",!,"You may build all the trees, or build them selectively, using 'verify'.",!,"Note that the 'compiled menus' will only be built into ^XUTL on this CPU.",!
"RTN","XQ81",14,0)
 S DIR(0)="Y",DIR("A")="Do you wish to verify each primary menu",DIR("B")="NO",DIR("??")="XQBUILDTREE-VER" D ^DIR K DIR G:$D(DIRUT) BLDEND1 S XQVE=(Y=1)
"RTN","XQ81",15,0)
 S DIR(0)="Y",DIR("A")="Would you like to build secondary menu trees too",DIR("B")="YES",DIR("??")="XQBUILDTREE-SEC" D ^DIR G:$D(DIRUT) BLDEND1 S XQBSEC=(Y=1)
"RTN","XQ81",16,0)
 ;
"RTN","XQ81",17,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Would you like to queue this job",DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) BLDEND1 I Y=1 D
"RTN","XQ81",18,0)
 .S ZTRTN="QUE^XQ81",ZTIO=""
"RTN","XQ81",19,0)
 .S ZTSAVE("XQVE")="",ZTSAVE("XQBSEC")="",ZTSAVE("XQSTART")=""
"RTN","XQ81",20,0)
 .S ZTDESC="Build menu trees in ^DIC(19,""AXQ"")"
"RTN","XQ81",21,0)
 .D ^%ZTLOAD
"RTN","XQ81",22,0)
 .I $D(ZTSK),'XQVE W !!,"Task #: ",ZTSK,!
"RTN","XQ81",23,0)
 .Q
"RTN","XQ81",24,0)
 ;
"RTN","XQ81",25,0)
 I $D(ZTSK) K ^DIC(19,"AXQ","P0") S XQALLDON="" G BLDEND
"RTN","XQ81",26,0)
 E  S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0"):DILOCKTM
"RTN","XQ81",27,0)
 ;
"RTN","XQ81",28,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Do you really wish to run this DIRECTLY (it may take some time)",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) BLDEND1 G:Y'=1 RD2
"RTN","XQ81",29,0)
 ;
"RTN","XQ81",30,0)
KIDS ;Entry from KIDS
"RTN","XQ81",31,0)
 I '$D(XQSTAT),$D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS I 'XQSTAT W !!,"  Some one else is building menus.  Sorry." K XQSTAT Q
"RTN","XQ81",32,0)
 I '$D(^DIC(19,"AXQ","P0","STOP")) D MICRO
"RTN","XQ81",33,0)
 I '$D(^DIC(19,"AXQ","P0")) S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0"):DILOCKTM
"RTN","XQ81",34,0)
 I '$D(XQVE) S XQFG=0,XQBSEC=1,XQVE=0
"RTN","XQ81",35,0)
 N XQNTREE,XQNDONE S (XQNTREE,XQNDONE)=0
"RTN","XQ81",36,0)
 ;
"RTN","XQ81",37,0)
 ;Set up the error trap so we can clear the screen if it blows
"RTN","XQ81",38,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XQ81"
"RTN","XQ81",39,0)
 E  S X="ERR^XQ81",@^%ZOSF("TRAP")
"RTN","XQ81",40,0)
 ;
"RTN","XQ81",41,0)
 ;Set up the bar graph and window if not from KIDS
"RTN","XQ81",42,0)
 I '$D(XPDNM) D INIT^XPDID
"RTN","XQ81",43,0)
 I XPDIDVT D
"RTN","XQ81",44,0)
 .I $D(XPDIDTOT) S XQSAVTOT=XPDIDTOT
"RTN","XQ81",45,0)
 .S X="Rebuilding Menus" D TITLE^XPDID(X)
"RTN","XQ81",46,0)
 .S XPDIDTOT=50 ;Number of divisions in bar graph
"RTN","XQ81",47,0)
 .D UPDATE^XPDID(0)
"RTN","XQ81",48,0)
 .Q
"RTN","XQ81",49,0)
 ;
"RTN","XQ81",50,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",51,0)
 W !!,"Starting Menu Rebuild:  ",XQSTART
"RTN","XQ81",52,0)
 S XQFG=0 W !!,"Collecting primary menus in the New Person file..."
"RTN","XQ81",53,0)
 ;
"RTN","XQ81",54,0)
DQ ;Entry from taskman  Write if $D(XQFG)
"RTN","XQ81",55,0)
 K ZTREQ
"RTN","XQ81",56,0)
 I '$D(XQSTART) S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",57,0)
 N XQNOW,XQ8FLG,XQTASK
"RTN","XQ81",58,0)
 S XQ8FLG=0
"RTN","XQ81",59,0)
 S:'$D(XQNOW) XQNOW=$H
"RTN","XQ81",60,0)
 S ^DIC(19,"AXQ","P0")=XQNOW
"RTN","XQ81",61,0)
 S ^DIC(19,"AXQ","P0","STOP")=XQNOW ;Stop micro surgery if it's running
"RTN","XQ81",62,0)
 ;
"RTN","XQ81",63,0)
 S XQSEC=1,XQ81T="" I 'XQVE H 1
"RTN","XQ81",64,0)
 S XQI="" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:XQI'=+XQI!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",65,0)
 S XQI="U" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"U"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",66,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2,$L(^(0)) S XQ81T=^(0) Q
"RTN","XQ81",67,0)
 S:XQ81T="" XQ81T="Unknown"
"RTN","XQ81",68,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I "P"[$E(XQI),XQI'="P0" K ^TMP("XQO",$J,XQI)
"RTN","XQ81",69,0)
 ;
"RTN","XQ81",70,0)
 ;Find the various trees and put them into ^TMP($J), and count them
"RTN","XQ81",71,0)
 S:'$D(XQH) XQH=$H K ^TMP($J) S XQI=.5 F XQK=0:0 S XQI=$O(^VA(200,XQI)) Q:XQI'=+XQI  I $D(^VA(200,XQI,0)),$L($P(^VA(200,XQI,0),U,3)) D SET
"RTN","XQ81",72,0)
 ;
"RTN","XQ81",73,0)
 S (XQNTREE,%)=0 F  S %=$O(^TMP($J,%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",74,0)
 S %=0 F  S %=$O(^TMP($J,"SEC",%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",75,0)
 ;
"RTN","XQ81",76,0)
 W:$D(XQFG) !!?20,"Primary menus found in the New Person file",!?20,"------------------------------------------"
"RTN","XQ81",77,0)
 W:$D(XQFG) !!,"OPTION NAME         MENU TEXT",?49,"# OF",?62,"LAST",?71,"LAST",!?49,"USERS",?62,"USED",?71,"BUILT",!
"RTN","XQ81",78,0)
 S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,XQBLD)) Q:XQBLD'>0!(X=U)  I $D(^DIC(19,XQBLD,0)) S XQJ=^DIC(19,XQBLD,0) D VER
"RTN","XQ81",79,0)
 S XQSEC=0 I $D(XQFG),XQBSEC W !!,"Building secondary menu trees...."
"RTN","XQ81",80,0)
 I XQBSEC S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,"SEC",XQBLD)) Q:XQBLD'>0  D SEC
"RTN","XQ81",81,0)
 I 'XQVE S XQK="P" F XQBLD=0:0 S XQK=$O(^TMP("XQO",$J,XQK)) Q:XQK'["P"  S ^(XQK,0)=XQH
"RTN","XQ81",82,0)
 G BLDEND
"RTN","XQ81",83,0)
 ;
"RTN","XQ81",84,0)
SEC S XQL="P"_XQBLD Q:$D(^TMP("XQO",$J,XQL))  D RD3 Q
"RTN","XQ81",85,0)
 S XQL="P" F XQN=0:0 S XQL=$O(^TMP("XQO",$J,XQL)) Q:$E(XQL)'="P"  I $D(^TMP("XQO",$J,XQL,"^",XQBLD)) Q
"RTN","XQ81",86,0)
 D:$E(XQL)'="P" RD3
"RTN","XQ81",87,0)
 Q
"RTN","XQ81",88,0)
 ;
"RTN","XQ81",89,0)
VER I $D(XQFG) D
"RTN","XQ81",90,0)
 .N XQMT,XQOPNM
"RTN","XQ81",91,0)
 .S XQK=$P(^TMP($J,XQBLD),U,2)
"RTN","XQ81",92,0)
 .S:$L(XQK) XQK=$E(XQK,4,5)_"/"_$E(XQK,6,7)_"/"_$E(XQK,2,3)
"RTN","XQ81",93,0)
 .S XQOPNM=$P(XQJ,U)
"RTN","XQ81",94,0)
 .S XQMT=$P(XQJ,U,2) I $L(XQMT)>28 S XQMT=$E(XQMT,1,25)_"..."
"RTN","XQ81",95,0)
 .W !,$P(XQJ,U,1)
"RTN","XQ81",96,0)
 .W:($L(XQOPNM)>20) !
"RTN","XQ81",97,0)
 .W ?20,XQMT,?49,+^TMP($J,XQBLD),?60,XQK
"RTN","XQ81",98,0)
 .Q
"RTN","XQ81",99,0)
 ;
"RTN","XQ81",100,0)
 I $D(XQFG) S:$D(^DIC(19,"AXQ","P"_XQBLD,0)) XQ81T=+^(0) I $L(XQ81T) S %H=XQ81T D YMD^%DTC S XQK=X W ?71,$E(XQK,4,5),"/",$E(XQK,6,7),"/",$E(XQK,2,3)
"RTN","XQ81",101,0)
 ;
"RTN","XQ81",102,0)
RD3 ;Update counter an rebuild it if necessary
"RTN","XQ81",103,0)
 I $D(XQFG),XPDIDVT D
"RTN","XQ81",104,0)
 .N %
"RTN","XQ81",105,0)
 .S XQNDONE=XQNDONE+1
"RTN","XQ81",106,0)
 .S %=(XQNDONE/XQNTREE)*XPDIDTOT
"RTN","XQ81",107,0)
 .D UPDATE^XPDID(%)
"RTN","XQ81",108,0)
 .Q
"RTN","XQ81",109,0)
 ;
"RTN","XQ81",110,0)
 S XQDIC="P"_XQBLD D CHK^XQ8 I XQRE W:$D(XQFG) !,"SOMEONE ELSE IS CURRENTLY REBUILDING THIS MENU" Q
"RTN","XQ81",111,0)
 I XQVE,XQSEC S DIR(0)="Y",DIR("A")="Rebuild",DIR("B")="YES" D ^DIR Q:$D(DIRUT)  W ! Q:Y'=1
"RTN","XQ81",112,0)
 S XQFG1=1 D PM2^XQ8
"RTN","XQ81",113,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ81",114,0)
 Q
"RTN","XQ81",115,0)
 ;
"RTN","XQ81",116,0)
SET G:'$D(^VA(200,XQI,201)) SET1 S XQK=+^(201) Q:'$L(XQK)  ;I $D(XQFG) W:'(XQI#10) "."
"RTN","XQ81",117,0)
 S XQR="" S:$D(^VA(200,XQI,1.1)) XQR=$P(^(1.1),".",1) S XQP=1_U_XQR
"RTN","XQ81",118,0)
 I $D(^TMP($J,XQK)) S XQP=^TMP($J,XQK) S XQP=XQP+1_U_$S(XQR>$P(XQP,U,2):XQR,1:$P(XQP,U,2))
"RTN","XQ81",119,0)
 I $D(^DIC(19,XQK,0)),$P(^(0),U,4)="M" S ^TMP($J,XQK)=XQP
"RTN","XQ81",120,0)
 ;
"RTN","XQ81",121,0)
SET1 I XQBSEC F XQN=0:0 S XQN=$O(^VA(200,XQI,203,XQN)) Q:XQN'>0  S XQL=+^(XQN,0) I $D(^DIC(19,XQL,0)),$P(^(0),U,4)="M" S ^TMP($J,"SEC",XQL)=""
"RTN","XQ81",122,0)
 Q
"RTN","XQ81",123,0)
 ;
"RTN","XQ81",124,0)
QUE ;Entry point for the option XQBUILDTREEQUE, and XQBUILDALL
"RTN","XQ81",125,0)
 ;Also called by CHEK^XQ83
"RTN","XQ81",126,0)
 S XQVE=0,XQBSEC=1 K XQFG
"RTN","XQ81",127,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",128,0)
 G DQ
"RTN","XQ81",129,0)
 ;
"RTN","XQ81",130,0)
BLDEND ;File a report, cleanup, and quit.
"RTN","XQ81",131,0)
 ;
"RTN","XQ81",132,0)
 K %,%H,%TG,C,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ
"RTN","XQ81",133,0)
 ;
"RTN","XQ81",134,0)
 I $D(XQALLDON) K XQALLDON Q  ;Quit here if we're just creating a task
"RTN","XQ81",135,0)
 ;
"RTN","XQ81",136,0)
 D MERGET
"RTN","XQ81",137,0)
 D CLEAN
"RTN","XQ81",138,0)
 D MERGEX
"RTN","XQ81",139,0)
 ;
"RTN","XQ81",140,0)
 K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ81",141,0)
 ;
"RTN","XQ81",142,0)
 ;Clear the flags and locks.
"RTN","XQ81",143,0)
 K ^XUTL("XQO","XQMERGED") ;Menus merged since last rebuild REACT^XQ84
"RTN","XQ81",144,0)
 K ^DIC(19,"AT") ;Micro message nodes
"RTN","XQ81",145,0)
 S ^XUTL("XQO","MICRO")=0 ;Number of Micro instances since last build
"RTN","XQ81",146,0)
 K ^DIC(19,"AXQ","P0","STOP") ;Allow Micro surgery to start up
"RTN","XQ81",147,0)
 K ^DIC(19,"AXQ","P0") ;Clear the rebuild flag (redundant, I know)
"RTN","XQ81",148,0)
 L -^DIC(19,"AXQ","P0") ;Unlock the rebuild flag, everybody's good to go
"RTN","XQ81",149,0)
 ;
"RTN","XQ81",150,0)
 S %=$S($D(XPDNM):"KIDS",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ81",151,0)
 D REPORT^XQ84(%)
"RTN","XQ81",152,0)
 K XQSTART,ZTSK
"RTN","XQ81",153,0)
 ;
"RTN","XQ81",154,0)
 I '$D(XPDIDVT) K XQFG Q
"RTN","XQ81",155,0)
 ;
"RTN","XQ81",156,0)
 I $D(XQFG),XPDIDVT F %=((XQNDONE/XQNTREE)*XPDIDTOT):1:XPDIDTOT D UPDATE^XPDID(%) H .25
"RTN","XQ81",157,0)
 I $D(XQFG),XPDIDVT D UPDATE^XPDID(XPDIDTOT)
"RTN","XQ81",158,0)
 I $D(XQFG) W !!,"Menu Rebuild Complete:  ",$$HTE^XLFDT($H)
"RTN","XQ81",159,0)
 ;
"RTN","XQ81",160,0)
 ;
"RTN","XQ81",161,0)
 H 2
"RTN","XQ81",162,0)
 ;If we're not from KIDS then clean it up, otherwise let kids do it.
"RTN","XQ81",163,0)
 I '$D(XPDNM) D
"RTN","XQ81",164,0)
 .D EXIT^XPDID()
"RTN","XQ81",165,0)
 .K XPDIDVT,XPDIDTOT
"RTN","XQ81",166,0)
 .Q
"RTN","XQ81",167,0)
 ;
"RTN","XQ81",168,0)
 I $D(XQSAVTOT) S XPDIDTOT=XQSAVTOT
"RTN","XQ81",169,0)
 K %,VALMCOFF,VALMCON,VALMIOXY,VALMSGR,VALMWD,XQFG,XQNDONE,XQNTREE,XQSAVTOT
"RTN","XQ81",170,0)
 Q
"RTN","XQ81",171,0)
 ;
"RTN","XQ81",172,0)
 ;================================Subroutines==========================
"RTN","XQ81",173,0)
 ;
"RTN","XQ81",174,0)
MERGET ;Merge ^TMP("XQO",$J) into ^DIC(19,"AXQ")
"RTN","XQ81",175,0)
 N Q,X,XQFLAG,Y S X="P",XQFLAG=0,Q=""""
"RTN","XQ81",176,0)
 I $D(XQFG) W !!,"Merging...."
"RTN","XQ81",177,0)
 F  S X=$O(^TMP("XQO",$J,X)) Q:X=""  D
"RTN","XQ81",178,0)
 .L +^DIC(19,"AXQ",X):2 I '$T S XQFLAG=1 Q
"RTN","XQ81",179,0)
 .S %X="^TMP(""XQO"","_$J_","_Q_X_Q_","
"RTN","XQ81",180,0)
 .S %Y="^DIC(19,""AXQ"","_Q_X_Q_","
"RTN","XQ81",181,0)
 .K ^DIC(19,"AXQ",X)
"RTN","XQ81",182,0)
 .;M ^DIC(19,"AXQ",X)=^TMP("XQO",$J,X)
"RTN","XQ81",183,0)
 .D %XY^%RCR
"RTN","XQ81",184,0)
 .L -^DIC(19,"AXQ",X)
"RTN","XQ81",185,0)
 .K %X,%Y
"RTN","XQ81",186,0)
 .Q
"RTN","XQ81",187,0)
 ;
"RTN","XQ81",188,0)
 I XQFLAG,$D(XQFG) D
"RTN","XQ81",189,0)
 .N %,Y
"RTN","XQ81",190,0)
 .S Y=$P(X,"P",2) Q:Y=""
"RTN","XQ81",191,0)
 .S %=$G(^DIC(19,Y,0)) Q:%=""
"RTN","XQ81",192,0)
 .S Y=$P(%,"^",2) Q:%=""
"RTN","XQ81",193,0)
 .W !,?12,"Could not merge menu: "_Y
"RTN","XQ81",194,0)
 .Q
"RTN","XQ81",195,0)
 Q
"RTN","XQ81",196,0)
 ;
"RTN","XQ81",197,0)
CLEAN ;Clean out unused menu trees from ^DIC(19,"AXQ")
"RTN","XQ81",198,0)
 N X,Y S X="P"
"RTN","XQ81",199,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",200,0)
 .I X'="PXU" D
"RTN","XQ81",201,0)
 ..S Y=$E(X,2,99)
"RTN","XQ81",202,0)
 ..I '$D(^TMP($J,Y))&('$D(^TMP($J,"SEC",Y))) K ^DIC(19,"AXQ",X),^XUTL("XQO",X)
"RTN","XQ81",203,0)
 ..Q
"RTN","XQ81",204,0)
 .Q
"RTN","XQ81",205,0)
 Q
"RTN","XQ81",206,0)
 ;
"RTN","XQ81",207,0)
MERGEX ;Merge ^DIC(19,"AXQ") into ^XUTL("XQO")
"RTN","XQ81",208,0)
 N Q,X,XQFLAG,Y S X="P",XQFLAG=0,Q=""""
"RTN","XQ81",209,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",210,0)
 .L +^XUTL("XQO",X):2 I '$T S XQFLAG=1 Q
"RTN","XQ81",211,0)
 .S %X="^DIC(19,""AXQ"","_Q_X_Q_","
"RTN","XQ81",212,0)
 .S %Y="^XUTL(""XQO"","_Q_X_Q_","
"RTN","XQ81",213,0)
 .K ^XUTL("XQO",X)
"RTN","XQ81",214,0)
 .;M ^XUTL("XQO",X)=^DIC(19,"AXQ",X)
"RTN","XQ81",215,0)
 .D %XY^%RCR
"RTN","XQ81",216,0)
 .L -^XUTL("XQO",X)
"RTN","XQ81",217,0)
 .K %X,%Y
"RTN","XQ81",218,0)
 .Q
"RTN","XQ81",219,0)
 ;
"RTN","XQ81",220,0)
 I XQFLAG,$D(XQFG) D
"RTN","XQ81",221,0)
 .N %,Y
"RTN","XQ81",222,0)
 .S Y=$P(X,"P",2) Q:Y=""
"RTN","XQ81",223,0)
 .S %=$G(^DIC(19,Y,0)) Q:%=""
"RTN","XQ81",224,0)
 .S Y=$P(%,"^",2) Q:%=""
"RTN","XQ81",225,0)
 .W !,?12,"Could not merge menu: "_Y
"RTN","XQ81",226,0)
 .Q
"RTN","XQ81",227,0)
 ;
"RTN","XQ81",228,0)
 I 'XQFLAG,$D(XQFG) W " done."
"RTN","XQ81",229,0)
 Q
"RTN","XQ81",230,0)
 ;
"RTN","XQ81",231,0)
STATUS()  ;Are the menus being rebuilt even as we speak?
"RTN","XQ81",232,0)
 N %,XQTHEN
"RTN","XQ81",233,0)
 S %=$G(^DIC(19,"AXQ","P0")) I %="" Q 1  ;It finished.  Never mind.
"RTN","XQ81",234,0)
 L +^DIC(19,"AXQ","P0"):0 ;If job is still running we can't lock it
"RTN","XQ81",235,0)
 I $T L -^DIC(19,"AXQ","P0") K ^("P0") Q 1  ;Job must have failed
"RTN","XQ81",236,0)
 Q 0
"RTN","XQ81",237,0)
 ;
"RTN","XQ81",238,0)
 ;
"RTN","XQ81",239,0)
MICRO ;Turn off micro surgery
"RTN","XQ81",240,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ81",241,0)
 .S ^DIC(19,"AXQ","P0","STOP")=$H ;Turn off micro-surgery
"RTN","XQ81",242,0)
 .K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ81",243,0)
 .H 2
"RTN","XQ81",244,0)
 .Q
"RTN","XQ81",245,0)
 Q
"RTN","XQ81",246,0)
 ;
"RTN","XQ81",247,0)
 ;
"RTN","XQ81",248,0)
ERR ;Come here on error
"RTN","XQ81",249,0)
 N XQERROR
"RTN","XQ81",250,0)
 S XQERROR=$$EC^%ZOSV
"RTN","XQ81",251,0)
 D ^%ZTER
"RTN","XQ81",252,0)
 D EXIT^XPDID()
"RTN","XQ81",253,0)
 G UNWIND^%ZTER
"RTN","XQ81",254,0)
 Q
"RTN","XQ81",255,0)
 ;
"RTN","XQ81",256,0)
BLDEND1 ;Quit and clean
"RTN","XQ81",257,0)
 K %,%H,%TG,C,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ
"RTN","XQ81",258,0)
 Q
"RTN","XQ84")
0^5^B60218862^B58717207
"RTN","XQ84",1,0)
XQ84 ;SEA/LUKE,ISD/HGW - Menu Rebuild Utilities ;03/20/13  10:49
"RTN","XQ84",2,0)
 ;;8.0;KERNEL;**157,253,614**;Jul 10, 1995;Build 11
"RTN","XQ84",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ84",4,0)
 ;
"RTN","XQ84",5,0)
SHOW ; Show what's in the global ^XUTL("XQO","REBUILDS")
"RTN","XQ84",6,0)
 I '$D(^XUTL("XQO","REBUILDS")) W !,"  Sorry, there is no data in the global ^XUTL(""XQO"",""REBUILDS"") to show you.",! Q
"RTN","XQ84",7,0)
 ;
"RTN","XQ84",8,0)
 N %,XQI,XQNL,XQNI,XQNT
"RTN","XQ84",9,0)
 N XQB,XQE,XQBY,XQTYPE,XQT,XQUCI,XQJ
"RTN","XQ84",10,0)
 ;
"RTN","XQ84",11,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","XQ84",12,0)
 W @IOF
"RTN","XQ84",13,0)
 S XQNL=0 ;Line counter
"RTN","XQ84",14,0)
 S XQNI=1 ;Item or occurance counter
"RTN","XQ84",15,0)
 S XQNT=$S($D(IOSL):IOSL-4,1:18) ;Number of lines on the screen
"RTN","XQ84",16,0)
 ;
"RTN","XQ84",17,0)
 D TITLE
"RTN","XQ84",18,0)
 D TOP
"RTN","XQ84",19,0)
 ;
"RTN","XQ84",20,0)
 S XQI=0
"RTN","XQ84",21,0)
 F  Q:$D(DIRUT)  S XQI=$O(^XUTL("XQO","REBUILDS",XQI)) Q:XQI=""  D
"RTN","XQ84",22,0)
 .S %=^XUTL("XQO","REBUILDS",XQI)
"RTN","XQ84",23,0)
 .S XQBY=$P($P(%,U,3),","),XQBY=$E(XQBY,1,12)
"RTN","XQ84",24,0)
 .S XQB=$P(%,U,1),XQE=$P(%,U,2),XQTYPE=$P(%,U,4),XQT=$P(%,U,5)
"RTN","XQ84",25,0)
 .S XQUCI="  Location:  "_$P(%,U,6,8)
"RTN","XQ84",26,0)
 .S XQJ="     Job #:  "_$P(%,U,9)
"RTN","XQ84",27,0)
 .D WRITE
"RTN","XQ84",28,0)
 .Q
"RTN","XQ84",29,0)
 ;
"RTN","XQ84",30,0)
 K DIRUT,DUOUT
"RTN","XQ84",31,0)
 Q
"RTN","XQ84",32,0)
 ;
"RTN","XQ84",33,0)
WRITE ;Write an entry unless the screen is full
"RTN","XQ84",34,0)
 I XQNL>XQNT D
"RTN","XQ84",35,0)
 .D WAIT Q:$D(DIRUT)
"RTN","XQ84",36,0)
 .W @IOF
"RTN","XQ84",37,0)
 .S XQNL=0
"RTN","XQ84",38,0)
 .D TOP
"RTN","XQ84",39,0)
 .Q
"RTN","XQ84",40,0)
 Q:$D(DIRUT)
"RTN","XQ84",41,0)
 W !,XQNI,".",?4,XQB,?28,XQE,?51,XQBY,?60,XQTYPE,?71,XQT,!,XQUCI,XQJ,!
"RTN","XQ84",42,0)
 S XQNL=XQNL+3,XQNI=XQNI+1
"RTN","XQ84",43,0)
 Q
"RTN","XQ84",44,0)
 ;
"RTN","XQ84",45,0)
TOP ; Format the top of the page
"RTN","XQ84",46,0)
 W !,?11,"Start",?35,"End",?53,"By",?59,"Type/Name",?72,"Task #",!
"RTN","XQ84",47,0)
 S XQNL=XQNL+2
"RTN","XQ84",48,0)
 Q
"RTN","XQ84",49,0)
 ;
"RTN","XQ84",50,0)
TITLE ;What is this all about?
"RTN","XQ84",51,0)
 N %
"RTN","XQ84",52,0)
 S %=$G(^XUTL("XQO","MICRO"))
"RTN","XQ84",53,0)
 W ?36,"Recent Menu Rebuilds",!
"RTN","XQ84",54,0)
 S XQNL=XQNL+2
"RTN","XQ84",55,0)
 W ?14,$S(%>0:%,1:"No")_" instances of Micro Surgery since last rebuild."
"RTN","XQ84",56,0)
 S XQNL=XQNL+2
"RTN","XQ84",57,0)
 Q
"RTN","XQ84",58,0)
 ;
"RTN","XQ84",59,0)
WAIT ;That's a screen load hold it here for a minute
"RTN","XQ84",60,0)
 N X,Y
"RTN","XQ84",61,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","XQ84",62,0)
 Q
"RTN","XQ84",63,0)
 ;
"RTN","XQ84",64,0)
 ;
"RTN","XQ84",65,0)
USER ;Rebuild the menu trees of a specific user
"RTN","XQ84",66,0)
 ;called by the option XQBUILDUSER
"RTN","XQ84",67,0)
 N XUN,XQCNT,XQSEC,XQREACT,XQPRIM,XQFL
"RTN","XQ84",68,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",69,0)
 ;
"RTN","XQ84",70,0)
 S XUN=+$$LOOKUP^XUSER Q:XUN'>0
"RTN","XQ84",71,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I XQPRIM'>0 W !!,"No Primary Menu defined for this user." Q
"RTN","XQ84",72,0)
 S XQCNT=1,XQREACT(XQCNT)=XQPRIM
"RTN","XQ84",73,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",74,0)
 .Q:'$D(^DIC(19,XQSEC,0))  ;Bad pointer don't use it
"RTN","XQ84",75,0)
 .I $P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)=XQSEC
"RTN","XQ84",76,0)
 .Q
"RTN","XQ84",77,0)
 ;
"RTN","XQ84",78,0)
 M XQREACTS=XQREACT  ;Save the originals
"RTN","XQ84",79,0)
 S XQCNTS=XQCNT
"RTN","XQ84",80,0)
 ;
"RTN","XQ84",81,0)
 S XQFL=$$FLAG(.XQREACT,.XQCNT)
"RTN","XQ84",82,0)
 I XQFL=1 D
"RTN","XQ84",83,0)
 .N DIR
"RTN","XQ84",84,0)
 .S DIR(0)="Y"
"RTN","XQ84",85,0)
 .S DIR("A")=" Are you sure you want to force a rebuild? "
"RTN","XQ84",86,0)
 .S DIR("A",1)="               ***WARNING*** "
"RTN","XQ84",87,0)
 .S DIR("A",2)=" Someone else may be rebuilding these trees right now."
"RTN","XQ84",88,0)
 .S DIR("?")=" Enter 'Y' to force a rebuild, 'N' to quit."
"RTN","XQ84",89,0)
 .D ^DIR
"RTN","XQ84",90,0)
 .I Y=1 D
"RTN","XQ84",91,0)
 ..M XQREACT=XQREACTS  ;Restore original list of menus
"RTN","XQ84",92,0)
 ..S XQCNT=XQCNTS
"RTN","XQ84",93,0)
 ..S XQFL=0
"RTN","XQ84",94,0)
 ..Q
"RTN","XQ84",95,0)
 .Q
"RTN","XQ84",96,0)
 ;
"RTN","XQ84",97,0)
 Q:XQFL  ;Flags are set, let's not mess with it.
"RTN","XQ84",98,0)
 ;
"RTN","XQ84",99,0)
 S DIR(0)="Y",DIR("A")=" Queue this rebuild? ",DIR("B")="Y"
"RTN","XQ84",100,0)
 S DIR("?")=" Please enter 'Y'es or 'N'o."
"RTN","XQ84",101,0)
 D ^DIR I Y=1 D
"RTN","XQ84",102,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",103,0)
 .S ZTSAVE("XUN")=""
"RTN","XQ84",104,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XQCNT")=""
"RTN","XQ84",105,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",106,0)
 .S ZTDESC="Rebuild "_$P(^VA(200,XUN,0),U)_"'s menu trees (DUZ="_XUN_")"
"RTN","XQ84",107,0)
 .D ^%ZTLOAD
"RTN","XQ84",108,0)
 .I $D(ZTSK) W !!," Task number: ",ZTSK
"RTN","XQ84",109,0)
 .Q
"RTN","XQ84",110,0)
 K DIR,Y
"RTN","XQ84",111,0)
 ;
"RTN","XQ84",112,0)
 I '$D(ZTSK) D REACTQ W !!," Done."
"RTN","XQ84",113,0)
 K ZTSK
"RTN","XQ84",114,0)
 Q
"RTN","XQ84",115,0)
 ;
"RTN","XQ84",116,0)
REACT(XUN) ;From XUSERNEW, check trees for reactivated user
"RTN","XQ84",117,0)
 ;
"RTN","XQ84",118,0)
 N XQCNT,XQSEC,XQREACT,XQPRIM,XQCHAT
"RTN","XQ84",119,0)
 S XQCHAT=1 I $D(XQUEUED)!$D(XWB) S XQCHAT=0 ;Anybody out there?
"RTN","XQ84",120,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I 'XQPRIM,'$D(XQQUE) W:XQCHAT !!,"** WARNING ** No Primary Menu defined." Q
"RTN","XQ84",121,0)
 I (XQPRIM'=+XQPRIM)!($G(^DIC(19,XQPRIM,0))="") Q
"RTN","XQ84",122,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",123,0)
 I XQPRIM,'$D(^DIC(19,"AXQ","P"_XQPRIM)),$P(^DIC(19,XQPRIM,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)="P"_XQPRIM
"RTN","XQ84",124,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",125,0)
 .Q:'$D(^DIC(19,XQSEC,0))  ;Bad pointer don't use it
"RTN","XQ84",126,0)
 .I '$D(^DIC(19,"AXQ","P"_XQSEC)),$P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)="P"_XQSEC
"RTN","XQ84",127,0)
 .Q
"RTN","XQ84",128,0)
 ;
"RTN","XQ84",129,0)
 Q:XQCNT=0  ;The menu trees look OK to me.
"RTN","XQ84",130,0)
 ;
"RTN","XQ84",131,0)
 N %
"RTN","XQ84",132,0)
 S %=$$FLAG(.XQREACT,.XQCNT) ;Are we already merging them (1)
"RTN","XQ84",133,0)
 Q:%
"RTN","XQ84",134,0)
 ;
"RTN","XQ84",135,0)
 I XQCNT>0 D
"RTN","XQ84",136,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",137,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XUN")=""
"RTN","XQ84",138,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",139,0)
 .S ZTDESC="Rebuild reactivated user's menu trees (DUZ="_XUN_")"
"RTN","XQ84",140,0)
 .D ^%ZTLOAD
"RTN","XQ84",141,0)
 .K ZTSK
"RTN","XQ84",142,0)
 .Q
"RTN","XQ84",143,0)
 Q
"RTN","XQ84",144,0)
 ;
"RTN","XQ84",145,0)
FLAG(XQARRAY,XQNUM1) ;Should we build a particular array of trees
"RTN","XQ84",146,0)
 ;Input: XQARRAY - array of trees e.g. P106, etc.  XQNUM1 number of trees
"RTN","XQ84",147,0)
 ;Output: 0 - There are trees to rebuild, 1 - Trees are already flagged
"RTN","XQ84",148,0)
 ;Merge flags e.g. [^XUTL("XQO","XQMERGED","P106)=$H] are set here
"RTN","XQ84",149,0)
 ; and killed in REACTQ+16
"RTN","XQ84",150,0)
 ;
"RTN","XQ84",151,0)
 N %,XQNUM,XQPXU S XQNUM=0
"RTN","XQ84",152,0)
 S %=$$STATUS^XQ81() I '% Q 1  ;Menus rebuilding
"RTN","XQ84",153,0)
 S XQPXU=$G(^DIC(19,"AXQ","PXU",0)) Q:XQPXU="" 1
"RTN","XQ84",154,0)
 S %="" F  S %=$O(XQARRAY(%)) Q:%=""  D
"RTN","XQ84",155,0)
 .N X
"RTN","XQ84",156,0)
 .S X=XQARRAY(%)
"RTN","XQ84",157,0)
 .I $D(^XUTL("XQO","XQMERGED",X)) D
"RTN","XQ84",158,0)
 ..N Y,Z
"RTN","XQ84",159,0)
 ..S Y=$G(^XUTL("XQO","XQMERGED",X)) Q:Y=""  ;Flag's gone
"RTN","XQ84",160,0)
 ..S Z=$$HDIFF^XLFDT(XQPXU,Y)
"RTN","XQ84",161,0)
 ..I Z>0 K ^XUTL("XQO","XQMERGED",X) ;Old Flag
"RTN","XQ84",162,0)
 ..Q
"RTN","XQ84",163,0)
 .I $D(^XUTL("XQO","XQMERGED",X)) K XQARRAY(%) Q
"RTN","XQ84",164,0)
 .S ^XUTL("XQO","XQMERGED",X)=$H,XQNUM=XQNUM+1 ;We'll merge this one
"RTN","XQ84",165,0)
 .Q
"RTN","XQ84",166,0)
 I XQNUM>0 S XQNUM1=XQNUM Q 0  ;There are some left to rebuild
"RTN","XQ84",167,0)
 Q 1
"RTN","XQ84",168,0)
 ;
"RTN","XQ84",169,0)
 ;
"RTN","XQ84",170,0)
REACTQ ;Queued job to rebuild a reactivated user's menu trees
"RTN","XQ84",171,0)
 ;  can also be run in real time by USER (above)
"RTN","XQ84",172,0)
 ;
"RTN","XQ84",173,0)
 N % S %=0
"RTN","XQ84",174,0)
 K ZTREQ ;Don't delete the task information
"RTN","XQ84",175,0)
 I $D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS^XQ81 Q:'XQSTAT  ;Menus are being rebuilt
"RTN","XQ84",176,0)
 Q:'$D(XQREACT)  ;Nothing to rebuild
"RTN","XQ84",177,0)
 ;
"RTN","XQ84",178,0)
 D MICRO^XQ81  ;Turn off Micro Surgery
"RTN","XQ84",179,0)
 S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ84",180,0)
 N XQCNT,XQDIC S XQCNT=""
"RTN","XQ84",181,0)
 K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ84",182,0)
 F  S XQCNT=$O(XQREACT(XQCNT)) Q:XQCNT=""  D
"RTN","XQ84",183,0)
 .S (XQFG1,XQXUF)="",XQDIC="P"_XQREACT(XQCNT)
"RTN","XQ84",184,0)
 .D PM2^XQ8
"RTN","XQ84",185,0)
 .Q:'$D(^TMP("XQO",$J,XQDIC))
"RTN","XQ84",186,0)
 .M ^DIC(19,"AXQ",XQDIC)=^TMP("XQO",$J,XQDIC) ;D MERGET^XQ81
"RTN","XQ84",187,0)
 .M ^XUTL("XQO",XQDIC)=^DIC(19,"AXQ",XQDIC)  ;D MERGEX^XQ81
"RTN","XQ84",188,0)
 .K ^XUTL("XQO","XQMERGED",XQREACT(XQCNT))
"RTN","XQ84",189,0)
 .Q
"RTN","XQ84",190,0)
 N DUZ S DUZ=XUN S XQDIC="U"_XUN D NEWSET^XQSET
"RTN","XQ84",191,0)
 K ^DIC(19,"AXQ","P0"),^TMP($J),^TMP("XQO",$J)
"RTN","XQ84",192,0)
 D REPORT($E($P(^VA(200,XUN,0),U),1,9))
"RTN","XQ84",193,0)
 K ^DIC(19,"AXQ","P0","STOP")
"RTN","XQ84",194,0)
 K D,I,W,X,XQK,XQQUE,XQXUF,Y,Z
"RTN","XQ84",195,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ84",196,0)
 Q
"RTN","XQ84",197,0)
 ;
"RTN","XQ84",198,0)
 ;
"RTN","XQ84",199,0)
REPORT(XQTYPE) ;Tell us what happened.
"RTN","XQ84",200,0)
 N %,X,XQI,XQJ,XQK,XQLINE,XQEND,Y
"RTN","XQ84",201,0)
 I '$D(^XUTL("XQO","MICRO")) S ^XUTL("XQO","MICRO")=0
"RTN","XQ84",202,0)
 I XQTYPE["MICRO" S ^XUTL("XQO","MICRO")=^XUTL("XQO","MICRO")+1 Q  ;Update Micro count
"RTN","XQ84",203,0)
 S XQEND=$$HTE^XLFDT($H)
"RTN","XQ84",204,0)
 I '$D(XQSTART) S XQSTART=XQEND
"RTN","XQ84",205,0)
 S XQLINE=XQSTART_"^"_XQEND_"^"_$P(^VA(200,DUZ,0),U,1)_"^"
"RTN","XQ84",206,0)
 ;S X=$S($D(^DIC(19,"AXQ","P0","MICRO")):"MICRO",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ84",207,0)
 S X=XQTYPE K XQTYPE
"RTN","XQ84",208,0)
 S Y=$S($D(ZTSK):ZTSK,1:"LIVE")
"RTN","XQ84",209,0)
 S XQLINE=XQLINE_X_"^"_Y
"RTN","XQ84",210,0)
 D GETENV^%ZOSV
"RTN","XQ84",211,0)
 S XQLINE=XQLINE_"^"_$P(Y,"^",1,3)_"^"_$J
"RTN","XQ84",212,0)
 I $D(^XUTL("XQO","REBUILDS")) D
"RTN","XQ84",213,0)
 .S (XQJ,XQK)=0
"RTN","XQ84",214,0)
 .F  S XQJ=$O(^XUTL("XQO","REBUILDS",XQJ)) Q:XQJ=""!(XQJ=49)  S XQK=XQK+1
"RTN","XQ84",215,0)
 .F XQI=XQK:-1:1 S ^XUTL("XQO","REBUILDS",XQI+1)=^(XQI)
"RTN","XQ84",216,0)
 .Q
"RTN","XQ84",217,0)
 S ^XUTL("XQO","REBUILDS",1)=XQLINE
"RTN","XQ84",218,0)
 Q
"RTN","XQ84",219,0)
 ;
"RTN","XQ84",220,0)
 ;
"RTN","XQ84",221,0)
NOW ;Is there a rebuild of any kind running right now?
"RTN","XQ84",222,0)
 N % S %=0
"RTN","XQ84",223,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ84",224,0)
 .W !!?6,"Micro surgery is currently updating the compiled menus."
"RTN","XQ84",225,0)
 .I $D(^DIC(19,"AXQ","AXQ","STOP")) D
"RTN","XQ84",226,0)
 ..W !?6,"... but it has been instructed to stop."
"RTN","XQ84",227,0)
 ..Q
"RTN","XQ84",228,0)
 .S %=47
"RTN","XQ84",229,0)
 .Q
"RTN","XQ84",230,0)
 Q:%=47
"RTN","XQ84",231,0)
 I $D(^DIC(19,"AXQ","P0")) D
"RTN","XQ84",232,0)
 .W !!?6," A complete menu rebuild is currently running."
"RTN","XQ84",233,0)
 .S %=47
"RTN","XQ84",234,0)
 .Q
"RTN","XQ84",235,0)
 Q:%=47
"RTN","XQ84",236,0)
 W !!?6,"There is no menu rebuild activity running on your system right now."
"RTN","XQ84",237,0)
 Q
"RTN","XQTOC")
0^3^B16729237^B17537937
"RTN","XQTOC",1,0)
XQTOC ;SEA/MJM - Time Out/Continue/Jump Start ;01/10/13  13:42
"RTN","XQTOC",2,0)
 ;;8.0;KERNEL;**20,157,593,614**;Jul 10, 1995;Build 11
"RTN","XQTOC",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQTOC",4,0)
 ;
"RTN","XQTOC",5,0)
 S ^XUTL("XQ",$J,1)=XQY_XQPSM_U_XQY0,^("T")=1
"RTN","XQTOC",6,0)
 Q:XQJS=0
"RTN","XQTOC",7,0)
 S %=^VA(200,DUZ,202.1) K ^(202.1) S $P(XQJS,U,2)=%,XQY=+%,XQPSM=$P(%,XQY,2,99),XQDIC=$S(XQPSM[",":$P(XQPSM,",",2),1:XQPSM)
"RTN","XQTOC",8,0)
 I '$D(^XUTL("XQO",XQDIC,"^",XQY)) D NOGO Q
"RTN","XQTOC",9,0)
 D
"RTN","XQTOC",10,0)
 .N %
"RTN","XQTOC",11,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",12,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",13,0)
 .I %]"" S XQOPTN=$P(%,"^",1,99)
"RTN","XQTOC",14,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",15,0)
 .Q
"RTN","XQTOC",16,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",17,0)
 ;
"RTN","XQTOC",18,0)
 W !!,"You were last executing the '",$P(XQOPTN,U,3),"' menu option."
"RTN","XQTOC",19,0)
ASK W !,"Do you wish to resume" S %=1 D YN^DICN I '% W !!,"If you wish to continue at the last option you were executing, enter 'Y',",! G ASK
"RTN","XQTOC",20,0)
 I %=1
"RTN","XQTOC",21,0)
 E  D NOGO Q
"RTN","XQTOC",22,0)
 ;
"RTN","XQTOC",23,0)
 D
"RTN","XQTOC",24,0)
 .N %
"RTN","XQTOC",25,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",26,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",27,0)
 .I %]"" S XQY0=$P(%,"^",2,99)
"RTN","XQTOC",28,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",29,0)
 .Q
"RTN","XQTOC",30,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",31,0)
 ;
"RTN","XQTOC",32,0)
 I $D(^XUTL("XQO",XQDIC,"^",XQY,0)) D
"RTN","XQTOC",33,0)
 .S XQ=^(0)
"RTN","XQTOC",34,0)
 .F XQI=1:1:XQ D
"RTN","XQTOC",35,0)
 ..N %
"RTN","XQTOC",36,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",37,0)
 ..I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",38,0)
 ..I %]"" S XQ(XQI)=%
"RTN","XQTOC",39,0)
 ..Q
"RTN","XQTOC",40,0)
 .Q
"RTN","XQTOC",41,0)
 E  S XQ=0
"RTN","XQTOC",42,0)
 Q
"RTN","XQTOC",43,0)
 ;
"RTN","XQTOC",44,0)
SET ;Set up variables to GO JUMP^XQ72.  Enter from ASK1+1^XQ
"RTN","XQTOC",45,0)
 S %=^XUTL("XQ",$J,1),XQSV=+%_U_+%_U_$P(%,U,2,99)
"RTN","XQTOC",46,0)
 K XQJS
"RTN","XQTOC",47,0)
 Q
"RTN","XQTOC",48,0)
 ;
"RTN","XQTOC",49,0)
LOOK ;Look up the Jump Start Entry
"RTN","XQTOC",50,0)
 F  Q:XQUR'[U  S XQUR=$P(XQUR,U,2)
"RTN","XQTOC",51,0)
 I '$L(XQUR) D NOGO Q
"RTN","XQTOC",52,0)
 D S^XQ75 I 'XQY D NOGO Q
"RTN","XQTOC",53,0)
 Q
"RTN","XQTOC",54,0)
 ;
"RTN","XQTOC",55,0)
NOGO ;Continue fails: reset to primary menu
"RTN","XQTOC",56,0)
 S XQY=^XUTL("XQ",$J,"XQM"),XQA3="",XQA=0 K XQCON,XQRE,XQJS,XQUR,XQOPTN
"RTN","XQTOC",57,0)
 D S1^XQCHK ; Reconstruct XQY0
"RTN","XQTOC",58,0)
 S $P(^XUTL("XQ",$J,0),U,3)=$P(^(0),U,3)_", NOGO"
"RTN","XQTOC",59,0)
 Q
"RTN","XQTOC",60,0)
 ;
"RTN","XQTOC",61,0)
 ;
"RTN","XQTOC",62,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQTOC",63,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQTOC",64,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQTOC",65,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_$G(DUZ("TEST"))_" Option: " G ASK^XQ
"RTN","XQTOC",66,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQTOC",67,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQTOC",68,0)
 W !!,$P("Great^OK^All right^Well certainly^Fine","^",$R(5)+1),".  ",$P("See you later.^I'll be ready when you are.^Hurry back!^Have a nice lunch.","^",$R(3)+X+1)
"RTN","XQTOC",69,0)
 G H^XUS
"RTN","XQTOC",70,0)
 ;
"RTN","XQTOC",71,0)
SS ;Search Secondaries for a particular option.
"RTN","XQTOC",72,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQTOC",73,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=+^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQTOC",74,0)
 Q
"VER")
8.0^22.0
"BLD",1486,6)
^497
**END**
**END**
